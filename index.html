<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAST DAY // SECURE TERMINAL (HOSTING FIX)</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --term-green: #00ff41;
            --term-dim: #00661a;
            --term-alert: #ff3333;
            --term-warn: #ffcc00;
            --term-orange: #ff8800;
            --term-blue: #33ccff;
            --term-gray: #888888;
            --term-glow: rgba(0, 255, 65, 0.6);
            --discord-color: #5865F2;
            --font-ui: 'Share Tech Mono', monospace;
            --font-body: 'Rajdhani', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            font-family: var(--font-ui);
            color: var(--term-green);
            overflow: hidden;
            height: 100vh; width: 100vw;
            text-shadow: 0 0 2px var(--term-dim), 0 0 5px var(--term-glow);
        }

        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 3px, 3px 100%; box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }
        .screen-flicker { animation: flicker 0.15s infinite; }
        @keyframes flicker { 0% { opacity: 0.97; } 5% { opacity: 0.94; } 10% { opacity: 0.97; } }
        .screen-transition { animation: turnOn 0.4s ease-out forwards; }
        @keyframes turnOn { 0% { transform: scale(1, 0.002); opacity: 0; filter: brightness(3); } 50% { transform: scale(1, 0.002); opacity: 1; } 100% { transform: scale(1, 1); opacity: 1; filter: brightness(1); } }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #001100; border-left: 1px solid var(--term-dim); }
        ::-webkit-scrollbar-thumb { background: var(--term-dim); border: 1px solid var(--term-green); }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden; padding: 40px;
            display: none; flex-direction: column;
        }
        #boot-screen { z-index: 100; display: block; font-size: 16px; white-space: pre-wrap; padding: 40px; }
        #login-screen { z-index: 90; align-items: center; justify-content: center; }
        
        #dashboard-screen, #relations-screen, #roster-screen, #operations-screen, 
        #research-hub, #unplanned-research, #planned-research-hub, #research-canvas-screen,
        #adepts-screen, #keys-screen, #access-screen { z-index: 80; overflow-y: auto; }
        
        #doc-viewer { 
            z-index: 200; background: #000; padding: 0; 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: none; flex-direction: column;
        }
        .doc-controls {
            height: 50px; background: #000; border-bottom: 1px solid var(--term-dim);
            display: flex; align-items: center; padding-left: 20px; flex-shrink: 0;
        }
        #doc-frame {
            flex-grow: 1; width: 100%; border: none; background: #fff; display: block;
        }

        .logo-container svg { width: 180px; height: 180px; margin-bottom: 40px; filter: drop-shadow(0 0 10px var(--term-green)); animation: rotateLogo 20s linear infinite; }
        @keyframes rotateLogo { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .input-group { text-align: center; display: flex; flex-direction: column; align-items: center; }
        .input-label { letter-spacing: 3px; margin-bottom: 10px; font-weight: bold; opacity: 0.8; }
        input[type="text"], input[type="password"] {
            background: rgba(0, 20, 0, 0.5); border: 2px solid var(--term-dim); color: var(--term-green); 
            font-family: var(--font-ui); font-size: 28px; padding: 10px 20px; width: 350px; 
            text-align: center; text-transform: uppercase; outline: none; box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
        }
        .error-msg { color: var(--term-alert); margin-top: 20px; height: 20px; font-weight: bold; opacity: 0; text-shadow: 0 0 5px red; }
        
        .hub-header { border-bottom: 2px solid var(--term-dim); padding-bottom: 15px; margin-bottom: 40px; display: flex; justify-content: space-between; align-items: flex-end; flex-shrink: 0; }
        .sub-header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; width: 100%; }
        .system-msg { color: var(--term-dim); margin: 0; font-size: 14px; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; width: 100%; }
        .menu-tile {
            border: 2px solid var(--term-dim); padding: 30px; cursor: pointer;
            background: rgba(0, 20, 0, 0.3); transition: all 0.2s; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 200px; text-align: center;
        }
        .menu-tile:hover { border-color: var(--term-green); background: rgba(0, 255, 65, 0.1); transform: scale(1.02); box-shadow: 0 0 25px rgba(0, 255, 65, 0.2); }
        
        .tile-icon { width: 48px; height: 48px; margin-bottom: 20px; color: var(--term-green); display: flex; align-items: center; justify-content: center; }
        .tile-icon svg { width: 100%; height: 100%; }
        
        .tile-title { font-size: 24px; font-weight: bold; letter-spacing: 2px; margin-bottom: 10px; }
        .tile-desc { font-size: 14px; color: #6dbf78; opacity: 0.8; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid var(--term-dim); }
        .data-table th { background: rgba(0, 255, 65, 0.1); text-align: left; padding: 15px; border-bottom: 2px solid var(--term-green); letter-spacing: 2px; text-transform: uppercase; font-size: 14px; }
        .data-table td { padding: 15px; border-bottom: 1px solid var(--term-dim); background: rgba(0,0,0,0.5); vertical-align: middle; font-size: 16px; }
        .data-table tr:hover td { background: rgba(0, 255, 65, 0.05); }

        select.term-select {
            background-color: #000; border: 1px solid var(--term-dim); color: var(--term-green);
            font-family: var(--font-ui); padding: 5px 10px; font-size: 16px; width: 100%;
            cursor: pointer; text-transform: uppercase; outline: none; transition: color 0.2s, border-color 0.2s;
        }
        select.term-select option { background-color: #000; color: var(--term-green); }

        .nav-btn, .back-btn {
            background: transparent; border: 1px solid var(--term-dim); color: var(--term-green);
            padding: 10px 20px; cursor: pointer; font-family: var(--font-ui); text-transform: uppercase;
            font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 10px; font-size: 14px;
        }
        .nav-btn:hover, .back-btn:hover { background: var(--term-green); color: #000; }
        
        .btn-activate {
            background: rgba(0, 255, 65, 0.1); border: 1px solid var(--term-green); color: var(--term-green);
            padding: 5px 10px; font-family: var(--font-ui); cursor: pointer; text-transform: uppercase;
            font-size: 14px; transition: all 0.2s; margin-top: 10px; width: 100%;
        }
        .btn-activate:hover:not(:disabled) { background: var(--term-green); color: #000; }
        .btn-activate:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--term-dim); }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .project-card {
            border: 1px solid var(--term-dim); padding: 25px; cursor: pointer;
            background: rgba(0, 20, 0, 0.2); transition: all 0.2s; position: relative;
        }
        .project-card:hover { border-color: var(--term-green); background: rgba(0, 255, 65, 0.1); transform: translateY(-2px); }
        .card-status { position: absolute; top: 15px; right: 15px; font-size: 10px; border: 1px solid; padding: 2px 6px; }
        .status-open { color: var(--term-green); border-color: var(--term-green); }
        .status-locked { color: var(--term-alert); border-color: var(--term-alert); }
        .card-title { font-size: 20px; margin-bottom: 10px; font-weight: bold; }
        .card-desc { font-size: 14px; color: #6dbf78; word-wrap: break-word; }

        .btn-delete {
            background: transparent; border: none; color: var(--term-green);
            font-family: var(--font-ui); font-weight: bold; cursor: pointer;
            font-size: 16px; padding: 2px 8px; transition: all 0.2s;
            text-shadow: 0 0 5px var(--term-green); position: relative; overflow: hidden;
        }
        .btn-delete:hover { background: #444; color: #fff; text-shadow: none; box-shadow: 0 0 8px rgba(255, 255, 255, 0.2); }
        .card-delete-pos { position: absolute; bottom: 10px; right: 10px; z-index: 20; font-size: 14px; }
        
        .spoiler-cell { cursor: pointer; user-select: none; font-family: 'Courier New', monospace; letter-spacing: 2px; transition: 0.2s; }
        .spoiler-hidden { background: var(--term-dim); color: transparent; text-shadow: none; position: relative; }
        .spoiler-hidden::after { content: "******"; color: var(--term-green); position: absolute; left: 15px; top: 15px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; justify-content: center; align-items: center; }
        .modal-box { border: 2px solid var(--term-dim); padding: 40px; text-align: center; color: var(--term-green); box-shadow: 0 0 50px rgba(0, 255, 65, 0.2); max-width: 500px; font-family: var(--font-ui); background: #000; max-height: 90vh; overflow-y: auto; }
        .modal-box.alert { border-color: var(--term-alert); color: var(--term-alert); box-shadow: 0 0 50px rgba(255, 51, 51, 0.2); }
        .modal-btn { background: transparent; border: 1px solid var(--term-green); color: var(--term-green); padding: 5px 20px; cursor: pointer; font-family: var(--font-ui); margin: 5px; }
        .modal-btn:hover { background: var(--term-green); color: #000; }
        .modal-btn.cancel { border-color: #666; color: #666; } .modal-btn.cancel:hover { background: #666; color: #fff; }
        .modal-btn.danger { border-color: var(--term-alert); color: var(--term-alert); } .modal-btn.danger:hover { background: var(--term-alert); color: #fff; }
        .modal-input { background: #000; border: 1px solid var(--term-dim); color: var(--term-green); padding: 10px; font-family: var(--font-ui); font-size: 20px; text-align: center; width: 100%; margin: 15px 0; outline: none; text-transform: uppercase; }
        
        /* CANVAS STYLES */
        #canvas-wrapper {
            position: relative; width: 100%; height: 80vh; 
            border: 1px solid var(--term-dim); background: rgba(0,10,0,0.3);
            overflow: auto; cursor: grab;
            background-image: radial-gradient(var(--term-dim) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        #canvas-wrapper.editing { cursor: crosshair; border-color: var(--term-warn); }
        #canvas-content { 
            position: relative; width: 4000px; height: 4000px; 
            transform-origin: 0 0;
        }
        
        .node-rect {
            position: absolute; width: 220px; min-height: 100px;
            background: #000; border: 2px solid var(--term-gray);
            padding: 10px; color: var(--term-green);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.8); transition: box-shadow 0.2s;
            user-select: none; z-index: 10; cursor: pointer;
        }
        .node-rect.status-approved { border-color: var(--term-green); box-shadow: 0 0 15px rgba(0,255,65,0.2); }
        .node-rect.status-rejected { border-color: var(--term-alert); color: var(--term-alert); }
        .node-rect:hover { z-index: 15; transform: scale(1.02); }
        
        .node-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; text-align: center; }
        .node-code { font-size: 12px; color: var(--term-dim); margin-bottom: 5px; }
        .node-img-preview { width: 100%; height: 60px; object-fit: cover; margin-bottom: 5px; border: 1px solid #333; display: none; }
        
        /* Connectors */
        .node-port {
            position: absolute; width: 12px; height: 12px;
            background: #000; border: 2px solid var(--term-gray); border-radius: 50%;
            cursor: pointer; z-index: 20;
        }
        .node-port:hover { background: var(--term-green); }
        .port-in { top: -8px; left: 50%; transform: translateX(-50%); }
        .port-out { bottom: -8px; left: 50%; transform: translateX(-50%); }

        .svg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5;
        }
        path.connection-line {
            fill: none; stroke: var(--term-gray); stroke-width: 2px;
        }
        path.connection-active { stroke: var(--term-green); filter: drop-shadow(0 0 2px var(--term-green)); }
        
        .node-delete-btn {
            position: absolute; top: -12px; right: -12px; 
            background: #000; color: var(--term-alert); border: 1px solid var(--term-alert);
            width: 24px; height: 24px; line-height: 22px; text-align: center; cursor: pointer;
            font-weight: bold; display: none; z-index: 30; pointer-events: auto; /* IMPORTANT */
        }
        .node-delete-btn:hover { background: var(--term-alert); color: #fff; }
        .editing .node-delete-btn { display: block; }
        
        .role-subordinate .btn-delete, 
        .role-subordinate .btn-activate,
        .role-subordinate .term-select { pointer-events: none; opacity: 0.7; }
        .role-subordinate select { -webkit-appearance: none; border: none; }
        
        .adept-layout { display: flex; gap: 20px; flex-wrap: wrap; }
        .adept-col { flex: 1; min-width: 300px; border: 1px solid var(--term-dim); padding: 10px; background: rgba(0,20,0,0.3); }
        .adept-col h3 { text-align: center; border-bottom: 1px solid var(--term-green); padding-bottom: 10px; margin-top: 0; }
        .adept-table th, .adept-table td { padding: 8px; font-size: 14px; }
        .adept-row { cursor: pointer; transition: 0.2s; }
        .adept-row:hover { background: rgba(0, 255, 65, 0.1); }
        
        .discord-input-container { border: 1px dashed var(--discord-color); padding: 10px; margin: 15px 0; background: rgba(88, 101, 242, 0.1); }
        .discord-label { color: var(--discord-color); font-size: 12px; margin-bottom: 5px; text-align: left; display: block; }
        .discord-input { border-color: var(--discord-color) !important; color: #7289da !important; }
        
        .info-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #333; padding: 5px 0; margin-bottom: 5px; font-size: 14px; }
        .info-label { color: var(--term-dim); }
        .info-val { font-weight: bold; text-align: right; }
        .role-badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; border: 1px solid; }
        
        .full-img-container { margin-top: 20px; border-top: 1px solid var(--term-dim); padding-top: 10px; }
        .full-img { width: 100%; height: auto; border: 1px solid var(--term-dim); margin-top: 10px; filter: grayscale(100%) contrast(1.2); }

        /* Z-INDEX FIX FOR DELETE MODAL - ENSURES IT IS ON TOP */
        #modal-delete-generic { z-index: 9999 !important; }
        #modal-access-denied, #modal-corrupted { z-index: 9999 !important; }
    </style>
</head>
<body class="screen-flicker">

<div class="crt-overlay"></div>

<!-- BOOT -->
<div id="boot-screen" class="screen" style="display: block;"></div>

<!-- LOGIN -->
<div id="login-screen" class="screen" style="display: none;">
    <div class="logo-container">
        <svg viewBox="0 0 200 200">
            <defs><filter id="glow"><feGaussianBlur stdDeviation="2.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
            <g stroke="#00ff41" stroke-width="2" fill="none" filter="url(#glow)">
                <circle cx="100" cy="100" r="80" stroke-dasharray="20,10" opacity="0.5"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="30s" repeatCount="indefinite"/></circle>
                <path d="M 100 20 L 170 160 L 30 160 Z" stroke-width="3" />
                <circle cx="100" cy="90" r="15" fill="#00ff41" />
                <path d="M 100 90 L 100 160" />
            </g>
        </svg>
    </div>
    <div class="input-group">
        <label class="input-label">SECURE LOGIN REQUIRED</label>
        <input type="password" id="password-input" maxlength="20" placeholder="_ _ _ _ _ _" autocomplete="off">
        <div class="error-msg" id="error-msg">>> ACCESS DENIED: INVALID HASH <<</div>
        <div id="login-status" style="margin-top:10px; font-size:12px; color:var(--term-dim);">WAITING FOR AUTH...</div>
    </div>
    <div style="margin-top: 40px; font-size: 10px; color: var(--term-dim); text-align: center;">LAST DAY NETWORK // V.6.2.6 (HOSTING FIX)</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard-screen" class="screen">
    <div class="hub-header">
        <div><div style="font-size: 28px; font-weight: bold;">OPERATING SYSTEM: SINGULARITY</div><div style="font-size: 12px; color: var(--term-dim); margin-top: 5px;">UNIT: <span id="user-role-display">UNKNOWN</span> | LOCATION: DEAD CITY</div></div>
        <div style="text-align: right;"><div>STATUS: <span class="blink" style="color:var(--term-green)">ONLINE</span></div><button id="logout-btn" class="nav-btn" style="margin-top: 5px; border-color: var(--term-alert); color: var(--term-alert);">[ LOGOUT ]</button></div>
    </div>
    <div class="dashboard-grid">
        <div class="menu-tile" id="btn-open-relations">
            <!-- NEW ICON: GLOBE -->
            <div class="tile-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="2" y1="12" x2="22" y2="12"></line>
                  <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
            </div>
            <div class="tile-title">DIPLOMACY</div><div class="tile-desc">Статусы отношений с фракциями зоны.</div>
        </div>
        <div class="menu-tile" id="btn-open-roster">
            <div class="tile-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>
            </div>
            <div class="tile-title">PERSONNEL</div><div class="tile-desc">Личный состав. Мониторинг.</div>
        </div>
        <div class="menu-tile" id="btn-open-adepts">
             <div class="tile-icon">
                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="10" r="4" /><path d="M6 21v-2a4 4 0 0 1 12 0v2" /><path d="M6 7a9 9 0 0 0 0 6" /><path d="M3 4a15 15 0 0 0 0 12" /><path d="M18 7a9 9 0 0 1 0 6" /><path d="M21 4a15 15 0 0 1 0 12" /></svg>
             </div>
             <div class="tile-title">ADEPTS REGISTRY</div><div class="tile-desc">Реестр испытуемых.</div>
        </div>
        <div class="menu-tile" id="btn-open-ops">
            <div class="tile-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>
            </div>
            <div class="tile-title">TACTICAL</div><div class="tile-desc">Боевые задачи.</div>
        </div>
        <div class="menu-tile" id="btn-open-keys">
            <div class="tile-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            </div>
            <div class="tile-title">ACCESS KEYS</div><div class="tile-desc">Коды доступа.</div>
        </div>
        <div class="menu-tile" id="btn-open-research-hub">
            <!-- NEW ICON: LIST/PAPER -->
            <div class="tile-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <line x1="10" y1="9" x2="8" y2="9"></line>
                </svg>
            </div>
            <div class="tile-title">RESEARCH</div><div class="tile-desc">База данных разработок.</div>
        </div>
        <div class="menu-tile restricted-tile" id="btn-open-access" style="display:none;">
            <!-- NEW ICON: SHIELD ONLY -->
            <div class="tile-icon" style="color: var(--term-blue);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
            </div>
            <div class="tile-title">ACCESS CONTROL</div><div class="tile-desc">Управление доступом.</div>
        </div>
    </div>
</div>

<!-- RESEARCH HUB SELECTION -->
<div id="research-hub" class="screen">
    <div class="hub-header"><div><div style="font-size: 24px; font-weight: bold;">RESEARCH DATABASE ACCESS</div></div><button class="nav-btn btn-back-dash"><< DASHBOARD</button></div>
    <div class="grid-container" style="margin-top: 50px;">
        <div class="menu-tile" id="btn-goto-planned">
            <div class="tile-title">PLANNED PROTOCOLS</div>
            <div class="tile-desc">Дерево стратегических разработок. Утверждено руководством.</div>
        </div>
        <div class="menu-tile" id="btn-goto-unplanned">
            <div class="tile-title">UNPLANNED DATA</div>
            <div class="tile-desc">Внеплановые проекты. Полевые исследования.</div>
        </div>
    </div>
</div>

<!-- UNPLANNED RESEARCH -->
<div id="unplanned-research" class="screen">
    <div class="hub-header"><div><div style="font-size: 24px; font-weight: bold;">UNPLANNED PROJECTS</div><div style="font-size: 12px; color: var(--term-dim);">ACCESS LEVEL: BETA</div></div><div style="text-align: right;"><button class="nav-btn" onclick="window.openScreen('research-hub')"><< BACK</button><button id="btn-add-proj" class="nav-btn role-restricted" style="margin-top: 5px;">+ ADD PROJECT</button></div></div>
    <div class="grid-container" id="research-grid"></div>
</div>

<!-- PLANNED RESEARCH HUB (BRANCH LIST) -->
<div id="planned-research-hub" class="screen">
    <div class="hub-header">
        <div><div style="font-size: 24px; font-weight: bold;">STRATEGIC BRANCHES</div><div style="font-size: 12px; color: var(--term-blue);">MASTER PROTOCOL</div></div>
        <div style="text-align: right;">
            <button class="nav-btn" onclick="window.openScreen('research-hub')"><< BACK</button>
            <button id="btn-add-branch" class="nav-btn role-restricted-admin" style="display:none; margin-top: 5px;">+ NEW BRANCH</button>
        </div>
    </div>
    <div class="grid-container" id="branches-grid"></div>
</div>

<!-- CANVAS SCREEN (THE TREE) -->
<div id="research-canvas-screen" class="screen" style="padding: 0; overflow: hidden;">
    <div class="doc-controls">
        <button class="back-btn" onclick="window.openScreen('planned-research-hub')"><< BRANCHES</button>
        <div style="margin-left: 20px; font-weight: bold;" id="canvas-branch-title">LOADING...</div>
        <div style="flex-grow:1;"></div>
        <!-- IMPORTANT: No inline onlcick here, controlled by JS -->
        <button id="btn-delete-branch" class="nav-btn role-restricted-admin" style="border-color: var(--term-alert); color: var(--term-alert); margin-right: 10px; display: none;">[ DELETE BRANCH ]</button>
        <button id="btn-edit-mode" class="nav-btn role-restricted-admin" style="border-color: var(--term-warn); color: var(--term-warn); margin-right: 10px; display: none;">[ EDIT MODE ]</button>
        <button id="btn-add-node" class="nav-btn" style="margin-right: 10px; display: none;">+ ADD NODE</button>
    </div>
    <div id="canvas-wrapper">
        <div id="canvas-content">
            <svg class="svg-layer" id="connections-layer"></svg>
            <!-- Nodes will be injected here -->
        </div>
    </div>
</div>

<!-- OTHER SCREENS -->
<div id="relations-screen" class="screen">
    <div class="hub-header">
        <div style="font-size: 24px; font-weight: bold;">FACTION RELATIONS</div>
        <button class="nav-btn btn-back-dash"><< DASHBOARD</button>
    </div>
    <p style="color: var(--term-dim); margin-bottom: 20px;">>> LIVE SYNCHRONIZATION: NOOSPHERE NET</p>
    <table class="data-table"><thead><tr><th style="width: 40%">FACTION NAME</th><th style="width: 40%">CURRENT STATUS</th><th style="width: 20%">THREAT LEVEL</th></tr></thead><tbody id="relations-body"></tbody></table>
</div>

<div id="roster-screen" class="screen">
    <div class="hub-header">
        <div style="font-size: 24px; font-weight: bold;">UNIT ROSTER</div>
        <button class="nav-btn btn-back-dash"><< DASHBOARD</button>
    </div>
    <div class="sub-header-controls">
        <p class="system-msg">>> LIVE BIOMETRIC FEED</p>
        <button id="btn-add-unit" class="nav-btn role-restricted">+ ADD UNIT</button>
    </div>
    <table class="data-table"><thead><tr><th>ID INDEX</th><th>DISCORD TAG</th><th>STEAM ID</th><th>RANK</th><th>STATUS</th><th>ACTION</th></tr></thead><tbody id="roster-body"></tbody></table>
</div>

<div id="adepts-screen" class="screen">
    <div class="hub-header">
        <div style="font-size: 24px; font-weight: bold;">ADEPT REGISTRY</div>
        <button class="nav-btn btn-back-dash"><< DASHBOARD</button>
    </div>
    <div class="sub-header-controls">
        <p class="system-msg">>> BIOMATERIAL CATEGORIZATION</p>
        <button id="btn-add-adept" class="nav-btn role-restricted">+ REGISTER SUBJECT</button>
    </div>
    <div class="adept-layout"><div class="adept-col"><h3>INITIATES (ACTIVE)</h3><table class="data-table adept-table"><tbody id="adepts-active-body"></tbody></table></div><div class="adept-col"><h3>SUBJECTS (TEST)</h3><table class="data-table adept-table"><tbody id="adepts-subject-body"></tbody></table></div><div class="adept-col"><h3>DETAINED (LABOR)</h3><table class="data-table adept-table"><tbody id="adepts-labor-body"></tbody></table></div></div>
</div>

<div id="keys-screen" class="screen">
    <div class="hub-header">
        <div style="font-size: 24px; font-weight: bold;">ACCESS KEY MANAGEMENT</div>
        <button class="nav-btn btn-back-dash"><< DASHBOARD</button>
    </div>
    <div class="sub-header-controls">
        <p class="system-msg">>> SECURE STORAGE: ENCRYPTED</p>
        <button id="btn-add-key" class="nav-btn role-restricted">+ ADD LOCK</button>
    </div>
    <table class="data-table"><thead><tr><th>IDENTIFIER</th><th>LOCATION</th><th>ACCESS CODE</th><th>ACTION</th></tr></thead><tbody id="keys-body"></tbody></table>
</div>

<div id="operations-screen" class="screen">
    <div class="hub-header">
        <div style="font-size: 24px; font-weight: bold;">TACTICAL OPERATIONS</div>
        <button class="nav-btn btn-back-dash"><< DASHBOARD</button>
    </div>
    <div class="sub-header-controls">
        <p class="system-msg">>> MISSION CONTROL</p>
        <button id="btn-add-op" class="nav-btn role-restricted">+ ADD OPERATION</button>
    </div>
    <table class="data-table"><thead><tr><th>CODENAME</th><th>TIME</th><th>UNITS</th><th>SECTOR</th><th>OBJECTIVES</th><th>SECRECY</th><th>STATUS</th><th>ACTION</th></tr></thead><tbody id="operations-body"></tbody></table>
</div>

<div id="access-screen" class="screen">
    <div class="hub-header">
        <div style="font-size: 24px; font-weight: bold; color: var(--term-blue);">USER ACCESS CONTROL</div>
        <button class="nav-btn btn-back-dash"><< DASHBOARD</button>
    </div>
    <div class="sub-header-controls">
        <p class="system-msg">>> GENERATE AUTHENTICATION TOKENS</p>
        <button id="btn-add-auth-key" class="nav-btn" style="color:var(--term-blue); border-color:var(--term-blue);">+ CREATE USER KEY</button>
    </div>
    <table class="data-table"><thead><tr><th>ACCESS KEY</th><th>ROLE ASSIGNED</th><th>CREATED BY</th><th>CREATED AT</th><th>ACTION</th></tr></thead><tbody id="access-body"></tbody></table>
</div>

<div id="doc-viewer" class="screen">
    <div class="doc-controls">
        <!-- FIXED CLOSE BUTTON -->
        <button id="btn-close-doc" class="back-btn" onclick="window.closeDocument()">[ < ] CLOSE FILE</button>
    </div>
    <iframe id="doc-frame" src="about:blank"></iframe>
</div>

<!-- MODALS -->
<div id="modal-access-denied" class="modal-overlay"><div class="modal-box alert"><h1>ACCESS DENIED</h1><button class="modal-btn danger close-modal">CLOSE</button></div></div>
<div id="modal-corrupted" class="modal-overlay"><div class="modal-box alert"><h1>DATA CORRUPTED</h1><button class="modal-btn danger close-modal">CLOSE</button></div></div>

<!-- GENERIC CONFIRM MODAL (Z-INDEX FIXED) -->
<div id="modal-delete-generic" class="modal-overlay">
    <div class="modal-box alert">
        <h1 id="delete-modal-title">CONFIRM DELETION</h1>
        <p>THIS ACTION CANNOT BE UNDONE.</p>
        <div style="margin-top: 30px;">
            <button id="btn-confirm-delete" class="modal-btn danger">DELETE</button>
            <button class="modal-btn cancel close-modal">CANCEL</button>
        </div>
    </div>
</div>

<!-- FORMS -->
<div id="modal-add-unit" class="modal-overlay"><div class="modal-box"><h1>ADD NEW UNIT</h1><p class="input-label">ID INDEX:</p><input id="new-unit-id" class="modal-input" placeholder="000-CODENAME"><div class="discord-input-container"><label class="discord-label">>> DISCORD COMM LINK:</label><input id="new-unit-discord" class="modal-input discord-input" placeholder="User#0000"></div><p class="input-label">STEAM ID:</p><input id="new-unit-steam" class="modal-input" placeholder="STEAM_0:1:..."><button id="confirm-add-unit" class="modal-btn">CONFIRM</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div>

<div id="modal-add-adept" class="modal-overlay"><div class="modal-box"><h1>REGISTER SUBJECT</h1><p class="input-label">CLASSIFICATION:</p><select id="new-adept-type" class="term-select"><option value="ACTIVE">ACTIVE ADEPT</option><option value="SUBJECT">SUBJECT</option><option value="DETAINED">DETAINED</option></select><p class="input-label">CODE:</p><input id="new-adept-code" class="modal-input" placeholder="A-001"><p class="input-label">NAME:</p><input id="new-adept-name" class="modal-input" placeholder="NAME"><p class="input-label">TIME:</p><input id="new-adept-time" class="modal-input" placeholder="HH:MM"><div class="discord-input-container"><label class="discord-label">>> DISCORD ID:</label><input id="new-adept-discord" class="modal-input discord-input" placeholder="1234..."></div><div id="adept-labor-fields" style="display:none;"><p class="input-label">WORK:</p><input id="new-adept-work" class="modal-input" placeholder="Digging"><p class="input-label">RELEASE:</p><input id="new-adept-release" class="modal-input" placeholder="HH:MM"></div><button id="confirm-add-adept" class="modal-btn">REGISTER</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div>

<div id="modal-add-key" class="modal-overlay"><div class="modal-box"><h1>ADD SECURE LOCK</h1><p class="input-label">IDENTIFIER:</p><input id="new-key-name" class="modal-input" placeholder="DOOR-1"><p class="input-label">DESCRIPTION:</p><input id="new-key-desc" class="modal-input" placeholder="LAB"><p class="input-label">CODE:</p><input id="new-key-code" class="modal-input" placeholder="0000"><button id="confirm-add-key" class="modal-btn">ADD LOCK</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div>

<div id="modal-add-project" class="modal-overlay"><div class="modal-box"><h1>INIT NEW PROTOCOL</h1><p class="input-label">CODENAME:</p><input id="new-proj-code" class="modal-input" placeholder="GBS-5"><p class="input-label">DESCRIPTION:</p><input id="new-proj-desc" class="modal-input" placeholder="SUMMARY"><p class="input-label">ACCESS:</p><select id="new-proj-status" class="term-select"><option value="BETA">BETA (CURRENT)</option><option value="ALPHA">ALPHA</option></select><label class="nav-btn" for="project-file-upload" style="margin-top:10px; text-align:center;">>> UPLOAD SOURCE FILE (.HTML)</label><input type="file" id="project-file-upload" style="display:none"><div id="file-name-display" style="font-size:12px; color:var(--term-dim); margin-top:5px;">NO DATA</div><button id="confirm-add-proj" class="modal-btn" style="margin-top:20px;">INITIALIZE</button><button class="modal-btn cancel close-modal" style="margin-top:20px;">CANCEL</button></div></div>

<div id="modal-add-op" class="modal-overlay"><div class="modal-box"><h1>NEW OPERATION</h1><p class="input-label">CODENAME:</p><input id="new-op-code" class="modal-input" placeholder="OP-TITAN"><p class="input-label">START:</p><input id="new-op-time" class="modal-input" placeholder="DD.MM HH:MM"><p class="input-label">UNITS:</p><input id="new-op-units" class="modal-input" placeholder="4"><p class="input-label">SECTOR:</p><input id="new-op-loc" class="modal-input" placeholder="AGROPROM"><p class="input-label">OBJECTIVES:</p><input id="new-op-obj" class="modal-input" placeholder="ELIMINATE"><p class="input-label">SECRECY:</p><select id="new-op-secrecy" class="term-select"><option value="SECRET">SECRET</option><option value="NON-SECRET">NON-SECRET</option></select><button id="confirm-add-op" class="modal-btn">CONFIRM</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div>

<div id="modal-add-auth-key" class="modal-overlay"><div class="modal-box" style="border-color:var(--term-blue);"><h1>GENERATE USER KEY</h1><p class="input-label">NEW KEY:</p><input id="new-auth-key-val" class="modal-input" placeholder="KEY-123"><p class="input-label">ROLE:</p><select id="new-auth-role" class="term-select"><option value="SUBORDINATE">SUBORDINATE</option><option id="opt-role-command" value="COMMAND">COMMAND</option><option id="opt-role-admin" value="ADMIN" style="display:none;">ADMIN</option></select><button id="confirm-add-auth-key" class="modal-btn" style="border-color:var(--term-blue); color:var(--term-blue);">GENERATE</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div>

<div id="modal-view-adept" class="modal-overlay">
    <div class="modal-box">
        <h1 style="border-bottom: 2px solid var(--term-green); padding-bottom: 10px;">SUBJECT DOSSIER</h1>
        <div id="view-adept-content"></div>
        <div style="margin-top:20px; text-align:center;">
            <p style="font-size:12px; color:#666;">UPDATE VITAL STATUS:</p>
            <select id="adept-status-change" class="term-select" style="text-align:center;">
                <option value="ЖИВ">ALIVE</option>
                <option value="УСТРАНЕН">ELIMINATED</option>
                <option value="ПРОПАЛ">MISSING</option>
            </select>
        </div>
        <div style="margin-top:20px;">
            <button id="view-adept-activate" class="btn-activate" style="display:none;">ACTIVATE PROTOCOL</button>
            <button id="view-adept-delete" class="modal-btn danger">TERMINATE SUBJECT</button>
            <button class="modal-btn cancel close-modal">CLOSE</button>
        </div>
    </div>
</div>

<div id="modal-add-branch" class="modal-overlay"><div class="modal-box"><h1>NEW RESEARCH BRANCH</h1><p class="input-label">BRANCH NAME:</p><input id="new-branch-name" class="modal-input" placeholder="WEAPONRY"><button id="confirm-add-branch" class="modal-btn">CREATE BRANCH</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div>

<div id="modal-node-details" class="modal-overlay">
    <div class="modal-box" style="max-width: 600px;">
        <h1 id="node-detail-title">NODE DETAILS</h1>
        <div style="text-align: left;">
            <p class="input-label">CODENAME:</p><input id="node-edit-code" class="modal-input">
            <p class="input-label">NAME:</p><input id="node-edit-name" class="modal-input">
            <p class="input-label">DESCRIPTION:</p><textarea id="node-edit-desc" class="modal-input" rows="3" style="text-align:left;"></textarea>
            
            <div id="node-admin-controls" style="display:none; border-top: 1px dashed var(--term-dim); padding-top: 10px; margin-top: 10px;">
                <p class="input-label" style="color:var(--term-warn)">ADMIN APPROVAL:</p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="modal-btn" onclick="window.updateNodeStatus('APPROVED')" style="border-color: #0f0; color:#0f0;">APPROVE</button>
                    <button class="modal-btn" onclick="window.updateNodeStatus('REJECTED')" style="border-color: #f00; color:#f00;">REJECT</button>
                    <button class="modal-btn" onclick="window.updateNodeStatus('PENDING')" style="border-color: #888; color:#888;">RESET</button>
                </div>
            </div>

            <div id="node-upload-controls" style="margin-top: 15px; border-top: 1px dashed var(--term-dim); padding-top: 10px;">
                <p class="input-label">ATTACHMENTS:</p>
                <label for="node-img-upload" class="nav-btn" style="width:100%; text-align:center; margin-bottom:5px;">>> UPLOAD IMAGE (PNG/JPG)</label>
                <input type="file" id="node-img-upload" style="display:none" accept="image/*">
                <div id="node-img-status" style="font-size:10px; color:gray; text-align:center;">NO IMAGE</div>
                <label for="node-html-upload" class="nav-btn" style="width:100%; text-align:center; margin-bottom:5px;">>> UPLOAD DATA FILE (.HTML)</label>
                <input type="file" id="node-html-upload" style="display:none" accept=".html">
                <div id="node-html-status" style="font-size:10px; color:gray; text-align:center;">NO FILE</div>
                <div style="display:flex; justify-content:space-between; margin-top: 10px;">
                     <button id="btn-view-node-file" class="nav-btn" style="display:none;">OPEN FILE</button>
                     <button id="btn-clear-node-file" class="modal-btn danger" style="display:none; font-size:10px;">CLEAR FILE</button>
                </div>
            </div>

            <div id="full-img-container" class="full-img-container" style="display:none;">
                <p class="input-label">VISUAL DATA:</p>
                <img id="full-node-img" class="full-img" src="">
            </div>
        </div>
        <div style="margin-top: 20px;">
            <button id="confirm-save-node" class="modal-btn">SAVE CHANGES</button>
            <button class="modal-btn cancel close-modal">CLOSE</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, where, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- STATE VARIABLES (Must be defined first) ---
    const HASH_GOD = "9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08"; 
    const HASH_ADMIN = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"; 
    const ROLES = { GOD: 'GOD', ADMIN: 'ADMIN', COMMAND: 'COMMAND', SUBORDINATE: 'SUBORDINATE' };

    let currentUser = null, db = null, auth = null;
    let appId = 'last-day-terminal-standalone'; 
    let CURRENT_ROLE = null, CURRENT_KEY_USED = null;
    let pendingDeleteId = null, pendingDeleteCol = null;
    let deleteTargetType = null; // 'BRANCH', 'NODE', 'DOC'
    let deleteTargetId = null;
    let deleteTargetCollection = null; 

    let currentBranchId = null, previousScreenId = 'dashboard-screen';
    let isEditMode = false;
    let isDragging = false, dragNodeId = null, dragOffsetX = 0, dragOffsetY = 0;
    let isLinking = false, linkSourceId = null;
    let canvasNodes = [], canvasEdges = []; 
    let uploadedNodeImg = null, uploadedNodeHtml = null;
    let currentNodeEditingId = null;

    // --- GLOBAL FUNCTIONS ---
    window.openScreen = function(screenId) { 
        document.querySelectorAll('.screen').forEach(el => { el.style.display = 'none'; el.classList.remove('screen-transition'); }); 
        const target = document.getElementById(screenId); target.style.display = 'flex'; target.classList.add('screen-transition'); 
    };
    
    // NAVIGATION FIX: Default to dashboard if history lost
    window.closeDocument = function() { 
        document.getElementById('doc-frame').src = "about:blank"; 
        window.openScreen(previousScreenId || 'dashboard-screen'); 
    };
    
    window.logout = function() { 
        document.getElementById('password-input').value = "";
        CURRENT_ROLE = null; 
        document.body.className = "";
        window.openScreen('login-screen'); 
    };
    
    window.closeModal = function(id) { const m = document.getElementById(id); if(m) m.style.display = 'none'; };

    window.colorizeSelect = function(el) {
        const val = el.value;
        if(['WAR', 'DECEASED', 'FAILED', 'REJECTED', 'УСТРАНЕН', 'CRITICAL', 'SECRET'].includes(val)) el.style.color = '#ff3333';
        else if(['ALLIANCE', 'ACTIVE', 'COMPLETED', 'APPROVED', 'ЖИВ', 'NON-SECRET'].includes(val)) el.style.color = '#00ff41';
        else if(['NEUTRAL', 'WOUNDED', 'IN_PROGRESS', 'ПРОПАЛ', 'PENDING'].includes(val)) el.style.color = '#ffcc00';
        else el.style.color = '#33ccff';
        el.style.borderColor = el.style.color;
    };

    window.updateDocField = async function(col, id, field, val) { 
        if(!db) return;
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id), {[field]: val}); 
        } catch (e) {
            console.error("Update failed:", e);
        }
    };
    
    window.askDelete = function(col, id) { 
        deleteTargetType = 'DOC'; deleteTargetCollection = col; deleteTargetId = id;
        document.getElementById('delete-modal-title').innerText = "CONFIRM DELETION";
        document.getElementById('modal-delete-generic').style.display = 'flex'; 
    };

    window.promptDeleteBranch = function(id) {
        deleteTargetType = 'BRANCH'; deleteTargetId = id;
        document.getElementById('delete-modal-title').innerText = "DELETE BRANCH?";
        document.getElementById('modal-delete-generic').style.display = 'flex'; 
    };

    window.promptDeleteNode = function(e, id) {
        if(e && e.stopPropagation) e.stopPropagation();
        deleteTargetType = 'NODE'; deleteTargetId = id;
        document.getElementById('delete-modal-title').innerText = "DELETE NODE?";
        document.getElementById('modal-delete-generic').style.display = 'flex'; 
    };

    async function executeDelete() {
        if(!db || !deleteTargetId) return;
        try {
            if (deleteTargetType === 'DOC') {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', deleteTargetCollection, deleteTargetId));
                // FIX: Close detail modal if deleting adept
                if (deleteTargetCollection === 'adepts') {
                     window.closeModal('modal-view-adept');
                }
            } else if (deleteTargetType === 'BRANCH') {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'research_branches', deleteTargetId));
                const batch = writeBatch(db);
                const nodes = canvasNodes.filter(n => n.branchId === deleteTargetId);
                const edges = canvasEdges.filter(e => e.branchId === deleteTargetId);
                nodes.forEach(n => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'research_nodes', n.id)));
                edges.forEach(e => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'research_edges', e.id)));
                await batch.commit();
                window.openScreen('planned-research-hub');
            } else if (deleteTargetType === 'NODE') {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'research_nodes', deleteTargetId));
                const batch = writeBatch(db);
                const edges = canvasEdges.filter(e => e.source === deleteTargetId || e.target === deleteTargetId);
                edges.forEach(e => batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'research_edges', e.id)));
                await batch.commit();
                renderCanvas();
            }
        } catch (error) { console.error("Delete failed:", error); alert("Error deleting: " + error.message); }
        window.closeModal('modal-delete-generic');
        deleteTargetType = null; deleteTargetId = null;
    }

    window.addNodeToCanvas = async function() {
        const wrapper = document.getElementById('canvas-wrapper');
        const centerX = wrapper.scrollLeft + (wrapper.clientWidth / 2) - 110; 
        const centerY = wrapper.scrollTop + (wrapper.clientHeight / 2) - 50;  
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'research_nodes'), {
                branchId: currentBranchId, x: Math.max(0, centerX), y: Math.max(0, centerY),
                title: "NEW NODE", code: "P-00", desc: "TBD", status: "PENDING", timestamp: Date.now()
            });
        } catch(e) { alert("Cannot add node: " + e.message); }
    };

    window.startLink = function(e, id) { e.stopPropagation(); e.preventDefault(); if(!isEditMode) return; isLinking = true; linkSourceId = id; };
    window.finishLink = async function(e, targetId) { e.stopPropagation(); if(isLinking && linkSourceId && linkSourceId !== targetId) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'research_edges'), { branchId: currentBranchId, source: linkSourceId, target: targetId, timestamp: Date.now() }); } isLinking = false; linkSourceId = null; };
    window.startDrag = function(e, id) { isDragging = true; dragNodeId = id; const el = document.querySelector(`.node-rect[data-id="${id}"]`); const rect = el.getBoundingClientRect(); dragOffsetX = e.clientX - rect.left; dragOffsetY = e.clientY - rect.top; };
    window.updateNodeStatus = async function(status) { if(!currentNodeEditingId) return; await window.updateDocField('research_nodes', currentNodeEditingId, 'status', status); window.closeModal('modal-node-details'); };

    // --- BOOT & AUTH ---
    const bootLines = ["LAST DAY OS v.6.2.6", "INITIALIZING SECURITY...", "CONNECTING TO FIREBASE...", "SYNCING NOOSPHERE...", "SYSTEM READY."];
    let lineIndex = 0;
    function typeBoot() {
        document.getElementById('boot-screen').style.display = 'block';
        if (lineIndex < bootLines.length) {
            const p = document.createElement('div'); p.style.fontFamily = "Share Tech Mono"; p.innerHTML = `> ${bootLines[lineIndex]}`; document.getElementById('boot-screen').appendChild(p);
            lineIndex++; setTimeout(typeBoot, 150);
        } else { setTimeout(() => { document.getElementById('boot-screen').style.display = 'none'; document.getElementById('login-screen').style.display = 'flex'; document.getElementById('password-input').focus(); }, 1000); }
    }
    window.onload = typeBoot;

    async function initFirebase() {
        try {
            // --- ВАЖНО: ВСТАВЬТЕ СЮДА ВАШ КОНФИГ ДЛЯ ХОСТИНГА ---
            // Если на хостинге не работает, замените объект ниже на ваш реальный конфиг из Firebase Console
            let config;
            if (typeof __firebase_config !== 'undefined') {
                config = JSON.parse(__firebase_config);
            } else {
                console.warn("CANVAS CONFIG NOT FOUND. USING FALLBACK/HOSTING CONFIG.");
                config = {
                    apiKey: "YOUR_API_KEY_HERE",
                    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
                    projectId: "YOUR_PROJECT_ID",
                    storageBucket: "YOUR_PROJECT_ID.appspot.com",
                    messagingSenderId: "SENDER_ID",
                    appId: "APP_ID"
                };
            }

            if(typeof __app_id !== 'undefined') appId = __app_id;
            
            console.log("Initializing Firebase with ID:", appId);
            const app = initializeApp(config); 
            db = getFirestore(app); 
            auth = getAuth(app);
            
            // AUTH HANDLER
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                console.log("Authenticating via Canvas Token...");
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                console.log("Authenticating via Anonymous Auth (Hosting Mode)...");
                await signInAnonymously(auth);
            }
            
            onAuthStateChanged(auth, (user) => { 
                currentUser = user; 
                if (user) {
                    console.log("Firebase Auth Success. UID:", user.uid);
                    setupListeners(); 
                } else {
                    console.warn("User signed out.");
                }
            });
        } catch (e) { 
            console.error("FIREBASE INIT ERROR:", e); 
            alert("CRITICAL SYSTEM FAILURE: FIREBASE INIT\n" + e.message + "\nCheck console for details.");
        }
    }

    async function getHash(msg) { if (!window.crypto || !window.crypto.subtle) return "FALLBACK"; const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(msg)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

    window.handleLogin = async () => {
        const key = document.getElementById('password-input').value.trim().toUpperCase();
        const hash = await getHash(key);
        let role = null;
        if(hash === HASH_GOD || key === "ZONE-OVERLORD-X7") role = ROLES.GOD;
        else if(hash === HASH_ADMIN || key === "LD-ADMIN-2025") role = ROLES.ADMIN;
        else { const snap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', 'system_access'), where('key', '==', key))); if(!snap.empty) role = snap.docs[0].data().role; }

        if(role) {
            CURRENT_ROLE = role; CURRENT_KEY_USED = key;
            document.getElementById('user-role-display').innerText = role; document.body.className = `role-${role.toLowerCase()}`;
            const isAdminOrGod = (role === ROLES.ADMIN || role === ROLES.GOD);
            document.querySelectorAll('.role-restricted-admin').forEach(el => {
                if(el.id !== 'btn-add-node' && el.id !== 'btn-delete-branch' && el.id !== 'btn-edit-mode') {
                    el.style.display = isAdminOrGod ? 'inline-block' : 'none';
                }
            });
            document.querySelectorAll('.role-restricted').forEach(el => el.style.display = (role === ROLES.SUBORDINATE) ? 'none' : 'inline-block');
            document.getElementById('btn-open-access').style.display = (role === ROLES.COMMAND || isAdminOrGod) ? 'flex' : 'none';
            window.openScreen('dashboard-screen');
        } else { document.getElementById('error-msg').style.opacity = 1; setTimeout(()=>document.getElementById('error-msg').style.opacity=0, 2000); }
    };
    document.getElementById('password-input').addEventListener('keypress', (e) => { if(e.key==='Enter') window.handleLogin(); });
    document.getElementById('logout-btn').onclick = window.logout;

    function setupListeners() {
        const base = (c) => collection(db, 'artifacts', appId, 'public', 'data', c);
        onSnapshot(base('factions'), s => renderTable('relations-body', s.docs, renderFactionRow));
        onSnapshot(base('roster'), s => renderTable('roster-body', s.docs, renderRosterRow));
        onSnapshot(base('adepts'), s => renderAdepts(s.docs));
        onSnapshot(base('keys'), s => renderTable('keys-body', s.docs, renderKeyRow));
        onSnapshot(base('operations'), s => renderTable('operations-body', s.docs, renderOpRow));
        onSnapshot(base('projects'), s => renderGrid('research-grid', s.docs, renderUnplannedProj));
        onSnapshot(base('system_access'), s => renderTable('access-body', s.docs, renderAccessRow));
        onSnapshot(base('research_branches'), s => renderGrid('branches-grid', s.docs, renderBranchCard));
        onSnapshot(base('research_nodes'), s => { canvasNodes = s.docs.map(d => ({id:d.id, ...d.data()})); if(currentBranchId) renderCanvas(); });
        onSnapshot(base('research_edges'), s => { canvasEdges = s.docs.map(d => ({id:d.id, ...d.data()})); if(currentBranchId) renderCanvas(); });
    }

    function renderTable(id, docs, rowFn) { const el = document.getElementById(id); if(!el) return; el.innerHTML = ''; docs.sort((a,b)=> (a.data().timestamp||0) - (b.data().timestamp||0)).forEach(d => el.appendChild(rowFn(d.id, d.data()))); }
    function renderGrid(id, docs, cardFn) { const el = document.getElementById(id); if(!el) return; el.innerHTML = ''; docs.sort((a,b)=> (a.data().timestamp||0) - (b.data().timestamp||0)).forEach(d => el.appendChild(cardFn(d.id, d.data()))); }

    function renderFactionRow(id, d) {
        const tr = document.createElement('tr'); const disabled = CURRENT_ROLE === ROLES.SUBORDINATE ? 'disabled' : '';
        tr.innerHTML = `<td><b>${d.name}</b></td><td><select class="term-select" ${disabled} onchange="window.updateDocField('factions','${id}','status',this.value); window.colorizeSelect(this);"><option value="UNKNOWN" ${d.status==='UNKNOWN'?'selected':''}>НЕ ЗНАКОМЫ</option><option value="NEUTRAL" ${d.status==='NEUTRAL'?'selected':''}>НЕЙТРАЛИТЕТ</option><option value="ALLIANCE" ${d.status==='ALLIANCE'?'selected':''}>СОЮЗ</option><option value="WAR" ${d.status==='WAR'?'selected':''}>ВОЙНА</option></select></td><td style="color:${d.status==='WAR'?'red':d.status==='ALLIANCE'?'#0f0':'#fc0'}">${d.status==='WAR'?'CRITICAL':d.status==='ALLIANCE'?'MINIMAL':'MODERATE'}</td>`;
        window.colorizeSelect(tr.querySelector('select'));
        return tr;
    }
    
    function renderRosterRow(id, d) {
        const tr = document.createElement('tr'); const disabled = CURRENT_ROLE === ROLES.SUBORDINATE ? 'disabled' : ''; const delBtn = CURRENT_ROLE !== ROLES.SUBORDINATE ? `<button class="btn-delete" onclick="window.askDelete('roster','${id}')">[X]</button>` : '';
        tr.innerHTML = `<td>${d.unitId}</td><td style="color:#7289da">${d.discordId||''}</td><td>${d.steamId||''}</td><td><select class="term-select" ${disabled} onchange="window.updateDocField('roster','${id}','rank',this.value)"><option ${d.rank==='NEOPHYTE'?'selected':''}>NEOPHYTE</option><option ${d.rank==='OPERATOR'?'selected':''}>OPERATOR</option><option ${d.rank==='ARCHITECT'?'selected':''}>ARCHITECT</option></select></td><td><select class="term-select health-select" ${disabled} onchange="window.updateDocField('roster','${id}','health',this.value); window.colorizeSelect(this);"><option value="ACTIVE" ${d.health==='ACTIVE'?'selected':''}>ACTIVE</option><option value="DECEASED" ${d.health==='DECEASED'?'selected':''}>DECEASED</option></select></td><td>${delBtn}</td>`;
        window.colorizeSelect(tr.querySelector('.health-select'));
        return tr;
    }
    
    function renderAdepts(docs) {
        const map = {ACTIVE:'adepts-active-body', SUBJECT:'adepts-subject-body', DETAINED:'adepts-labor-body'}; Object.values(map).forEach(id => document.getElementById(id).innerHTML='');
        docs.forEach(d => { const data = d.data(); const tr = document.createElement('tr'); tr.className='adept-row'; tr.innerHTML=`<td>${data.code}</td><td>${data.name}</td><td style="color:${data.status==='ЖИВ'?'#0f0':'red'}">${data.status}</td>`; tr.onclick = () => window.openAdeptDetails({id:d.id, ...data}); const target = document.getElementById(map[data.type] || map.ACTIVE); if(target) target.appendChild(tr); });
    }
    
    function renderUnplannedProj(id, d) {
        const div = document.createElement('div'); div.className = "project-card"; const del = CURRENT_ROLE !== ROLES.SUBORDINATE ? `<button class="btn-delete card-delete-pos" onclick="event.stopPropagation(); window.askDelete('projects','${id}')">[X]</button>` : '';
        div.innerHTML = `<div class="card-status ${d.status==='BETA'?'status-open':'status-locked'}">${d.status}</div><div class="card-title">${d.code}</div><div class="card-desc">${d.desc}</div><div style="margin-top:20px; font-size:12px; color:gray;">${d.status==='BETA'?'>> CLICK TO ACCESS':'>> RESTRICTED'}</div>${del}`;
        div.onclick = () => { if(d.status==='BETA' && d.content) window.openUserProject(d.content, 'unplanned-research'); else document.getElementById('modal-access-denied').style.display='flex'; };
        return div;
    }
    
    function renderBranchCard(id, d) {
        const div = document.createElement('div'); div.className = "project-card";
        div.innerHTML = `<div class="card-title">${d.name}</div><div class="card-desc">PROTOCOL ROOT</div><div style="margin-top:20px; color:#0f0;">>> ENTER MATRIX</div>`;
        div.onclick = () => loadBranch(id, d.name);
        return div;
    }

    function loadBranch(branchId, title) {
        currentBranchId = branchId;
        isEditMode = false;
        document.getElementById('canvas-wrapper').classList.remove('editing');
        document.getElementById('btn-edit-mode').innerText = "[ EDIT MODE ]";
        document.getElementById('btn-add-node').style.display = 'none';
        document.getElementById('canvas-branch-title').innerText = "BRANCH: " + title;
        window.openScreen('research-canvas-screen');
        
        const delBranchBtn = document.getElementById('btn-delete-branch');
        const editModeBtn = document.getElementById('btn-edit-mode');
        
        if(CURRENT_ROLE === ROLES.ADMIN || CURRENT_ROLE === ROLES.GOD) {
            delBranchBtn.style.display = 'inline-block';
            delBranchBtn.onclick = () => window.promptDeleteBranch(branchId);
            editModeBtn.style.display = 'inline-block';
        } else {
            delBranchBtn.style.display = 'none';
            editModeBtn.style.display = 'none';
        }
        renderCanvas();
    }

    function renderCanvas() {
        const container = document.getElementById('canvas-content');
        container.querySelectorAll('.node-rect').forEach(n => n.remove());
        const svg = document.getElementById('connections-layer'); svg.innerHTML = '';

        const nodes = canvasNodes.filter(n => n.branchId === currentBranchId);
        const edges = canvasEdges.filter(e => e.branchId === currentBranchId);

        edges.forEach(e => {
            const src = nodes.find(n => n.id === e.source);
            const tgt = nodes.find(n => n.id === e.target);
            if(src && tgt) {
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", getOrthoPath(src.x, src.y, tgt.x, tgt.y));
                path.setAttribute("class", "connection-line " + (src.status === 'APPROVED' ? 'connection-active' : ''));
                svg.appendChild(path);
            }
        });

        nodes.forEach(n => {
            const div = document.createElement('div');
            div.className = `node-rect status-${n.status.toLowerCase()}`;
            div.style.left = n.x + 'px'; div.style.top = n.y + 'px';
            div.setAttribute('data-id', n.id);
            let html = `<div class="node-title">${n.title}</div><div class="node-code">${n.code}</div>`;
            if(n.imageUrl) html += `<img src="${n.imageUrl}" class="node-img-preview" style="display:block;">`;
            let stText = n.status === 'APPROVED' ? 'APPROVED' : n.status === 'REJECTED' ? 'DENIED' : 'UNVERIFIED';
            html += `<div style="font-size:10px; color:${n.status==='APPROVED'?'#0f0':n.status==='REJECTED'?'red':'gray'}; border-top:1px solid #333; width:100%; text-align:center; margin-top:5px;">${stText}</div>`;
            
            if(CURRENT_ROLE === ROLES.GOD || CURRENT_ROLE === ROLES.ADMIN) {
                html += `<div class="node-delete-btn" onclick="window.promptDeleteNode(event, '${n.id}')">X</div>`;
                html += `<div class="node-port port-in" onmouseup="window.finishLink(event, '${n.id}')"></div><div class="node-port port-out" onmousedown="window.startLink(event, '${n.id}')"></div>`;
            }
            div.innerHTML = html;
            div.addEventListener('mousedown', (e) => { 
                if(!isEditMode) return;
                if(e.target.classList.contains('node-port') || e.target.classList.contains('node-delete-btn')) return;
                window.startDrag(e, n.id); 
            });
            div.addEventListener('dblclick', () => window.openNodeDetails(n));
            container.appendChild(div);
        });
    }

    const wrapper = document.getElementById('canvas-wrapper');
    wrapper.addEventListener('mousemove', (e) => {
        if(isDragging && dragNodeId) {
            const rect = wrapper.getBoundingClientRect();
            let x = e.clientX - rect.left + wrapper.scrollLeft - dragOffsetX;
            let y = e.clientY - rect.top + wrapper.scrollTop - dragOffsetY;
            x = Math.round(x / 10) * 10; y = Math.round(y / 10) * 10;
            if(x < 0) x = 0; if(y < 0) y = 0;
            const el = document.querySelector(`.node-rect[data-id="${dragNodeId}"]`); if(el) { el.style.left = x + 'px'; el.style.top = y + 'px'; }
        }
    });
    wrapper.addEventListener('mouseup', async (e) => { if(isDragging && dragNodeId) { const el = document.querySelector(`.node-rect[data-id="${dragNodeId}"]`); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'research_nodes', dragNodeId), {x: parseInt(el.style.left), y: parseInt(el.style.top)}); renderCanvas(); } isDragging = false; dragNodeId = null; isLinking = false; });

    function getOrthoPath(x1, y1, x2, y2) { const sx = x1 + 110; const sy = y1 + 100; const tx = x2 + 110; const ty = y2; const midY = (sy + ty) / 2; return `M ${sx} ${sy} L ${sx} ${midY} L ${tx} ${midY} L ${tx} ${ty}`; }

    window.openNodeDetails = (n) => {
        currentNodeEditingId = n.id;
        document.getElementById('modal-node-details').style.display = 'flex';
        document.getElementById('node-edit-code').value = n.code || '';
        document.getElementById('node-edit-name').value = n.title || '';
        document.getElementById('node-edit-desc').value = n.desc || '';
        document.getElementById('node-admin-controls').style.display = (CURRENT_ROLE === ROLES.GOD || CURRENT_ROLE === ROLES.ADMIN) ? 'block' : 'none';
        document.getElementById('node-img-status').innerText = n.imageUrl ? "IMAGE LOADED" : "NO IMAGE";
        document.getElementById('node-html-status').innerText = n.htmlContent ? "FILE LOADED" : "NO FILE";
        
        const viewBtn = document.getElementById('btn-view-node-file'); const clearBtn = document.getElementById('btn-clear-node-file');
        if(n.htmlContent) { viewBtn.style.display = 'inline-block'; viewBtn.onclick = () => { window.openUserProject(n.htmlContent, 'research-canvas-screen'); }; if(CURRENT_ROLE !== ROLES.SUBORDINATE) { clearBtn.style.display = 'inline-block'; clearBtn.onclick = async () => { await updateDocField('research_nodes', n.id, 'htmlContent', null); window.closeModal('modal-node-details'); }; } } else { viewBtn.style.display = 'none'; clearBtn.style.display = 'none'; }
        
        const imgContainer = document.getElementById('full-img-container');
        const fullImg = document.getElementById('full-node-img');
        if(n.imageUrl) { imgContainer.style.display = 'block'; fullImg.src = n.imageUrl; } else { imgContainer.style.display = 'none'; }

        document.querySelectorAll('#modal-node-details .modal-input').forEach(i => i.disabled = (CURRENT_ROLE === ROLES.SUBORDINATE));
        document.getElementById('node-upload-controls').style.display = (CURRENT_ROLE === ROLES.SUBORDINATE) ? 'none' : 'block';
    };
    
    document.getElementById('btn-edit-mode').addEventListener('click', () => { 
        isEditMode = !isEditMode; 
        document.getElementById('canvas-wrapper').classList.toggle('editing', isEditMode); 
        document.getElementById('btn-edit-mode').innerText = isEditMode ? "[ EXIT EDIT ]" : "[ EDIT MODE ]"; 
        document.getElementById('btn-add-node').style.display = isEditMode ? 'inline-block' : 'none'; 
        renderCanvas(); 
    });

    document.getElementById('btn-confirm-delete').onclick = executeDelete;
    document.getElementById('btn-add-node').onclick = function() { window.addNodeToCanvas(); };
    
    document.getElementById('confirm-save-node').onclick = async () => {
        if(!currentNodeEditingId) return;
        const updates = { code: document.getElementById('node-edit-code').value, title: document.getElementById('node-edit-name').value, desc: document.getElementById('node-edit-desc').value };
        if(uploadedNodeImg) updates.imageUrl = uploadedNodeImg; if(uploadedNodeHtml) updates.htmlContent = uploadedNodeHtml;
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'research_nodes', currentNodeEditingId), updates);
            uploadedNodeImg = null; uploadedNodeHtml = null; window.closeModal('modal-node-details');
        } catch(e) { alert("Error saving node: " + e.message); }
    };

    document.getElementById('node-img-upload').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { uploadedNodeImg = ev.target.result; document.getElementById('node-img-status').innerText = "READY TO SAVE"; }; if(e.target.files[0]) r.readAsDataURL(e.target.files[0]); };
    document.getElementById('node-html-upload').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { uploadedNodeHtml = ev.target.result; document.getElementById('node-html-status').innerText = "READY TO SAVE"; }; if(e.target.files[0]) r.readAsText(e.target.files[0]); };
    document.getElementById('btn-add-branch').onclick = () => document.getElementById('modal-add-branch').style.display='flex';
    document.getElementById('confirm-add-branch').onclick = async () => { 
        const n = document.getElementById('new-branch-name').value.trim().toUpperCase(); 
        if(n) { 
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'research_branches'), {name:n, timestamp:Date.now()}); 
                window.closeModal('modal-add-branch'); 
            } catch(e) { alert("Cannot add branch: " + e.message); }
        } 
    };

    const bindAdd = (btnId, modalId, inputs, col, mapper) => {
        document.getElementById(btnId).onclick = () => document.getElementById(modalId).style.display='flex';
        document.getElementById(btnId.replace('btn-','confirm-')).onclick = async () => {
            const vals = inputs.map(id => document.getElementById(id).value.trim());
            if(vals[0]) { 
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', col), mapper(vals)); 
                    window.closeModal(modalId); 
                } catch(e) {
                    alert("Operation failed: " + e.message + "\nCheck database permissions and auth.");
                    console.error(e);
                }
            }
        };
    };

    bindAdd('btn-add-unit', 'modal-add-unit', ['new-unit-id','new-unit-discord','new-unit-steam'], 'roster', v => ({unitId:v[0].toUpperCase(), discordId:v[1], steamId:v[2], rank:'NEOPHYTE', health:'ACTIVE', timestamp: Date.now()}));
    bindAdd('btn-add-key', 'modal-add-key', ['new-key-name','new-key-desc','new-key-code'], 'keys', v => ({name:v[0].toUpperCase(), desc:v[1], code:v[2], timestamp: Date.now()}));
    bindAdd('btn-add-op', 'modal-add-op', ['new-op-code','new-op-time','new-op-units','new-op-loc','new-op-obj'], 'operations', v => ({code:v[0].toUpperCase(), time:v[1], units:v[2], sector:v[3].toUpperCase(), objectives:v[4], secrecy: document.getElementById('new-op-secrecy').value, status:'PENDING', timestamp: Date.now()}));
    
    document.getElementById('btn-add-adept').onclick = () => document.getElementById('modal-add-adept').style.display='flex';
    document.getElementById('confirm-add-adept').onclick = async () => {
        const type = document.getElementById('new-adept-type').value;
        const d = { type, code: document.getElementById('new-adept-code').value.toUpperCase(), name: document.getElementById('new-adept-name').value, time: document.getElementById('new-adept-time').value, discordId: document.getElementById('new-adept-discord').value, status: "ЖИВ", timestamp: Date.now() };
        if(type==='ACTIVE') d.isActivated = false; if(type==='DETAINED') { d.workDesc = document.getElementById('new-adept-work').value; d.releaseTime = document.getElementById('new-adept-release').value; }
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'adepts'), d); 
            window.closeModal('modal-add-adept');
        } catch(e) { alert("Failed to register subject: " + e.message); }
    };
    
    document.getElementById('btn-add-proj').onclick = () => document.getElementById('modal-add-project').style.display='flex';
    const projFileIn = document.getElementById('project-file-upload'); let projFileContent = null;
    projFileIn.onchange = (e) => { const r = new FileReader(); r.onload=ev=>{projFileContent=ev.target.result; document.getElementById('file-name-display').innerText="LOADED";}; if(e.target.files[0]) r.readAsText(e.target.files[0]); };
    document.getElementById('confirm-add-proj').onclick = async () => {
        const c = document.getElementById('new-proj-code').value.toUpperCase();
        if(c) { 
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), { code: c, title: "PROJECT: "+c, desc: document.getElementById('new-proj-desc').value, status: document.getElementById('new-proj-status').value, content: projFileContent, timestamp: Date.now() }); 
                window.closeModal('modal-add-project'); 
            } catch(e) { alert("Failed to add project: " + e.message); }
        }
    };
    
    document.querySelectorAll('.btn-back-dash').forEach(b => b.onclick = () => { previousScreenId = 'dashboard-screen'; window.openScreen('dashboard-screen'); });
    
    const navMap = {'btn-open-relations':'relations-screen', 'btn-open-roster':'roster-screen', 'btn-open-adepts':'adepts-screen', 'btn-open-keys':'keys-screen', 'btn-open-ops':'operations-screen', 'btn-open-research-hub':'research-hub', 'btn-open-access':'access-screen', 'btn-goto-unplanned':'unplanned-research', 'btn-goto-planned':'planned-research-hub'};
    for(const [btn, scr] of Object.entries(navMap)) { document.getElementById(btn).onclick = () => { previousScreenId = scr; window.openScreen(scr); }; }

    document.querySelectorAll('.close-modal').forEach(btn => { btn.addEventListener('click', (e) => { e.target.closest('.modal-overlay').style.display = 'none'; }); });
    document.getElementById('new-adept-type').onchange = (e) => document.getElementById('adept-labor-fields').style.display = (e.target.value==='DETAINED'?'block':'none');
    
    document.getElementById('btn-add-auth-key').onclick = () => { document.getElementById('modal-add-auth-key').style.display='flex'; document.getElementById('opt-role-admin').style.display = (CURRENT_ROLE===ROLES.GOD?'block':'none'); document.getElementById('opt-role-command').style.display = (CURRENT_ROLE===ROLES.COMMAND?'none':'block'); };
    document.getElementById('confirm-add-auth-key').onclick = async () => { 
        const k = document.getElementById('new-auth-key-val').value.toUpperCase(); 
        if(k) {
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'system_access'), {key:k, keyHash: await getHash(k), role: document.getElementById('new-auth-role').value, createdBy: CURRENT_KEY_USED, timestamp: Date.now()}); 
                window.closeModal('modal-add-auth-key'); 
            } catch(e) { alert("Failed to generate key: " + e.message); }
        }
    };
    
    function renderAccessRow(id, d) {
        if(CURRENT_ROLE===ROLES.SUBORDINATE) return document.createElement('tr'); if(CURRENT_ROLE===ROLES.COMMAND && d.role!==ROLES.SUBORDINATE) return document.createElement('tr'); if(CURRENT_ROLE===ROLES.ADMIN && d.role===ROLES.GOD) return document.createElement('tr');
        const tr = document.createElement('tr'); tr.innerHTML=`<td class="spoiler-cell spoiler-hidden" onclick="this.classList.toggle('spoiler-hidden')">${d.key||d.keyHash.substr(0,10)}</td><td>${d.role}</td><td>${d.createdBy||'UNK'}</td><td>${new Date(d.timestamp).toLocaleDateString()}</td><td><button class="btn-delete" onclick="window.askDelete('system_access','${id}')">REVOKE</button></td>`; return tr;
    }
    function renderKeyRow(id, d) { const tr = document.createElement('tr'); const del = CURRENT_ROLE !== ROLES.SUBORDINATE ? `<button class="btn-delete" onclick="window.askDelete('keys','${id}')">[X]</button>` : ''; tr.innerHTML=`<td><b>${d.name}</b></td><td>${d.desc}</td><td class="spoiler-cell spoiler-hidden" onclick="this.classList.toggle('spoiler-hidden')">${d.code}</td><td>${del}</td>`; return tr; }
    function renderOpRow(id, d) { const tr = document.createElement('tr'); const disabled = CURRENT_ROLE === ROLES.SUBORDINATE ? 'disabled' : ''; const del = CURRENT_ROLE !== ROLES.SUBORDINATE ? `<button class="btn-delete" onclick="window.askDelete('operations','${id}')">[X]</button>` : ''; tr.innerHTML=`<td>${d.code}</td><td>${d.time}</td><td>${d.units}</td><td>${d.sector}</td><td style="font-size:12px;">${d.objectives}</td><td style="color:${d.secrecy==='SECRET'?'red':'#0f0'}">${d.secrecy}</td><td><select class="term-select op-select" ${disabled} onchange="window.updateDocField('operations','${id}','status',this.value); window.colorizeSelect(this);"><option value="PENDING" ${d.status==='PENDING'?'selected':''}>PENDING</option><option value="IN_PROGRESS" ${d.status==='IN_PROGRESS'?'selected':''}>IN PROGRESS</option><option value="COMPLETED" ${d.status==='COMPLETED'?'selected':''}>COMPLETED</option><option value="FAILED" ${d.status==='FAILED'?'selected':''}>FAILED</option></select></td><td>${del}</td>`; 
        window.colorizeSelect(tr.querySelector('.op-select')); return tr; }
    
    window.openAdeptDetails = (a) => {
        const c = document.getElementById('view-adept-content'); const act = document.getElementById('view-adept-activate'); const del = document.getElementById('view-adept-delete');
        c.innerHTML = `<div class="info-row"><span class="info-label">CODE:</span><span>${a.code}</span></div><div class="info-row"><span class="info-label">NAME:</span><span>${a.name}</span></div><div class="info-row"><span class="info-label">STATUS:</span><span style="color:${a.status==='ЖИВ'?'#0f0':'red'}">${a.status}</span></div>`;
        
        const sel = document.getElementById('adept-status-change');
        if(sel) {
            sel.value = a.status || "ЖИВ";
            sel.disabled = (CURRENT_ROLE === ROLES.SUBORDINATE);
            window.colorizeSelect(sel);
            sel.onchange = async () => {
                await window.updateDocField('adepts', a.id, 'status', sel.value);
                window.colorizeSelect(sel);
                const statusSpan = c.querySelector('.info-row:nth-child(3) span:nth-child(2)');
                if(statusSpan) { statusSpan.innerText = sel.value; statusSpan.style.color = sel.style.color; }
            };
        }

        document.getElementById('modal-view-adept').style.display='flex';
        act.style.display = (a.type==='ACTIVE' && CURRENT_ROLE!==ROLES.SUBORDINATE) ? 'block' : 'none'; act.disabled = a.isActivated; act.innerText = a.isActivated ? "ACTIVATED" : "ACTIVATE";
        act.onclick = async () => { 
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'signal_queue'), {type:'ACTIVATION', targetCode:a.code, targetDiscordId:a.discordId, timestamp:serverTimestamp()}); 
                await window.updateDocField('adepts',a.id,'isActivated',true); 
                window.closeModal('modal-view-adept'); 
            } catch(e) { alert("Error activating: " + e.message); }
        };
        del.style.display = (CURRENT_ROLE!==ROLES.SUBORDINATE) ? 'block' : 'none'; del.onclick = () => window.askDelete('adepts', a.id);
    };

    window.openUserProject = (c, fromScreen) => { 
        if(fromScreen) previousScreenId = fromScreen;
        document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        const f = document.getElementById('doc-frame'); f.contentWindow.document.open(); f.contentWindow.document.write(c); f.contentWindow.document.close(); window.openScreen('doc-viewer'); 
    };

    initFirebase();
</script>
</body>
</html>
