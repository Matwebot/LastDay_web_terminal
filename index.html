<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAST DAY // SECURE TERMINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            /* Основные цвета */
            --term-green: #00ff41;
            --term-dim: #00661a;
            --term-alert: #ff3333;
            --term-warn: #ffcc00;
            --term-orange: #ff8800;
            --term-gray: #888888;
            --term-glow: rgba(0, 255, 65, 0.6);
            
            /* Алиасы для совместимости с чертежами */
            --primary: var(--term-green);
            --dim: var(--term-dim);
            --alert: var(--term-alert);

            /* Сетка документа */
            --grid-line: rgba(0, 255, 65, 0.08);
            
            /* Шрифты */
            --font-ui: 'Share Tech Mono', monospace;
            --font-body: 'Rajdhani', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            font-family: var(--font-ui);
            color: var(--term-green);
            overflow: hidden;
            height: 100vh; width: 100vw;
            text-shadow: 0 0 2px var(--term-dim), 0 0 5px var(--term-glow);
        }

        /* CRT Effects */
        .crt-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 3px, 3px 100%; box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
        }
        .screen-flicker { animation: flicker 0.15s infinite; }
        @keyframes flicker { 0% { opacity: 0.97; } 5% { opacity: 0.94; } 10% { opacity: 0.97; } }
        .screen-transition { animation: turnOn 0.4s ease-out forwards; }
        @keyframes turnOn { 0% { transform: scale(1, 0.002); opacity: 0; filter: brightness(3); } 50% { transform: scale(1, 0.002); opacity: 1; } 100% { transform: scale(1, 1); opacity: 1; filter: brightness(1); } }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #001100; border-left: 1px solid var(--term-dim); }
        ::-webkit-scrollbar-thumb { background: var(--term-dim); border: 1px solid var(--term-green); }

        /* Screens */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden; padding: 40px;
            display: none; flex-direction: column;
        }
        #boot-screen { z-index: 100; display: block; font-size: 16px; white-space: pre-wrap; padding: 40px; }
        #login-screen { z-index: 90; align-items: center; justify-content: center; }
        #dashboard-screen, #relations-screen, #roster-screen, #operations-screen, #main-hub { z-index: 80; overflow-y: auto; }
        
        /* Iframe Doc Viewer */
        #doc-viewer { 
            z-index: 85; background: #050505; padding: 0; 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            display: none; flex-direction: column;
        }
        .doc-controls {
            height: 50px; background: #000; border-bottom: 1px solid var(--term-dim);
            display: flex; align-items: center; padding-left: 20px; flex-shrink: 0;
        }
        #doc-frame {
            flex-grow: 1; width: 100%; border: none; background: #fff; display: block;
        }

        /* UI Elements */
        .logo-container svg { width: 180px; height: 180px; margin-bottom: 40px; filter: drop-shadow(0 0 10px var(--term-green)); animation: rotateLogo 20s linear infinite; }
        @keyframes rotateLogo { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .input-group { text-align: center; display: flex; flex-direction: column; align-items: center; }
        .input-label { letter-spacing: 3px; margin-bottom: 10px; font-weight: bold; opacity: 0.8; }
        input[type="text"], input[type="password"] {
            background: rgba(0, 20, 0, 0.5); border: 2px solid var(--term-dim); color: var(--term-green); 
            font-family: var(--font-ui); font-size: 28px; padding: 10px 20px; width: 350px; 
            text-align: center; text-transform: uppercase; outline: none; box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
        }
        .error-msg { color: var(--term-alert); margin-top: 20px; height: 20px; font-weight: bold; opacity: 0; text-shadow: 0 0 5px red; }
        .hub-header { border-bottom: 2px solid var(--term-dim); padding-bottom: 15px; margin-bottom: 40px; display: flex; justify-content: space-between; align-items: flex-end; flex-shrink: 0; }
        
        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; max-width: 1200px; margin: 0 auto; width: 100%; }
        .menu-tile {
            border: 2px solid var(--term-dim); padding: 30px; cursor: pointer;
            background: rgba(0, 20, 0, 0.3); transition: all 0.2s; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 200px; text-align: center;
        }
        .menu-tile:hover { border-color: var(--term-green); background: rgba(0, 255, 65, 0.1); transform: scale(1.02); box-shadow: 0 0 25px rgba(0, 255, 65, 0.2); }
        .tile-icon { font-size: 48px; margin-bottom: 20px; color: var(--term-green); display: flex; align-items: center; justify-content: center; }
        .tile-title { font-size: 24px; font-weight: bold; letter-spacing: 2px; margin-bottom: 10px; }
        .tile-desc { font-size: 14px; color: #6dbf78; opacity: 0.8; }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid var(--term-dim); }
        .data-table th { background: rgba(0, 255, 65, 0.1); text-align: left; padding: 15px; border-bottom: 2px solid var(--term-green); letter-spacing: 2px; }
        .data-table td { padding: 15px; border-bottom: 1px solid var(--term-dim); background: rgba(0,0,0,0.5); vertical-align: middle; }
        .data-table tr:hover td { background: rgba(0, 255, 65, 0.05); }

        select.term-select {
            background-color: #000; border: 1px solid var(--term-dim); color: var(--term-green);
            font-family: var(--font-ui); padding: 5px 10px; font-size: 16px; width: 100%;
            cursor: pointer; text-transform: uppercase; outline: none;
        }
        select.term-select option { background-color: #000; color: var(--term-green); }

        .status-war { color: var(--term-alert); border-color: var(--term-alert); }
        .status-neutral { color: var(--term-warn); border-color: var(--term-warn); }
        .status-alliance { color: var(--term-green); border-color: var(--term-green); }
        tr[data-status="WAR"] td { border-left: 3px solid var(--term-alert); }
        tr[data-status="ALLIANCE"] td { border-left: 3px solid var(--term-green); }
        tr[data-status="NEUTRAL"] td { border-left: 3px solid var(--term-warn); }

        .nav-btn, .back-btn {
            background: transparent; border: 1px solid var(--term-dim); color: var(--term-green);
            padding: 10px 20px; cursor: pointer; font-family: var(--font-ui); text-transform: uppercase;
            font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 10px;
        }
        .nav-btn:hover, .back-btn:hover { background: var(--term-green); color: #000; }

        /* Project Cards */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .project-card {
            border: 1px solid var(--term-dim); padding: 25px; cursor: pointer;
            background: rgba(0, 20, 0, 0.2); transition: all 0.2s; position: relative;
        }
        .project-card:hover { border-color: var(--term-green); background: rgba(0, 255, 65, 0.1); transform: translateY(-2px); }
        .card-status { position: absolute; top: 15px; right: 15px; font-size: 10px; border: 1px solid; padding: 2px 6px; }
        .status-open { color: var(--term-green); border-color: var(--term-green); }
        .status-locked { color: var(--term-alert); border-color: var(--term-alert); }
        .card-title { font-size: 20px; margin-bottom: 10px; font-weight: bold; }
        .card-desc { font-size: 14px; color: #6dbf78; word-wrap: break-word; }

        /* Buttons */
        .btn-delete {
            background: transparent; border: none; color: var(--term-green);
            font-family: var(--font-ui); font-weight: bold; cursor: pointer;
            font-size: 16px; padding: 2px 8px; transition: all 0.2s;
            text-shadow: 0 0 5px var(--term-green); position: relative; overflow: hidden;
        }
        .btn-delete:hover { background: #444; color: #fff; text-shadow: none; box-shadow: 0 0 8px rgba(255, 255, 255, 0.2); }
        .btn-delete:hover::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.3) 3px); pointer-events: none;
        }
        .card-delete-pos { position: absolute; bottom: 10px; right: 10px; z-index: 20; font-size: 14px; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; justify-content: center; align-items: center; }
        .modal-box { border: 2px solid var(--term-dim); padding: 40px; text-align: center; color: var(--term-green); box-shadow: 0 0 50px rgba(0, 255, 65, 0.2); max-width: 500px; font-family: var(--font-ui); background: #000; }
        .modal-box.alert { border-color: var(--term-alert); color: var(--term-alert); box-shadow: 0 0 50px rgba(255, 51, 51, 0.2); }
        .modal-btn { background: transparent; border: 1px solid var(--term-green); color: var(--term-green); padding: 5px 20px; cursor: pointer; font-family: var(--font-ui); margin: 5px; }
        .modal-btn:hover { background: var(--term-green); color: #000; }
        .modal-btn.cancel { border-color: #666; color: #666; } .modal-btn.cancel:hover { background: #666; color: #fff; }
        .modal-btn.danger { border-color: var(--term-alert); color: var(--term-alert); } .modal-btn.danger:hover { background: var(--term-alert); color: #fff; }
        .modal-input { background: #000; border: 1px solid var(--term-dim); color: var(--term-green); padding: 10px; font-family: var(--font-ui); font-size: 20px; text-align: center; width: 100%; margin: 15px 0; outline: none; text-transform: uppercase; }
        .modal-input:focus { border-color: var(--term-green); box-shadow: 0 0 10px var(--term-green); }
    </style>
</head>
<body class="screen-flicker">

<div class="crt-overlay"></div>

<!-- BOOT -->
<div id="boot-screen" class="screen"></div>

<!-- LOGIN -->
<div id="login-screen" class="screen" style="display: none;">
    <div class="logo-container">
        <svg viewBox="0 0 200 200">
            <defs><filter id="glow"><feGaussianBlur stdDeviation="2.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
            <g stroke="#00ff41" stroke-width="2" fill="none" filter="url(#glow)">
                <circle cx="100" cy="100" r="80" stroke-dasharray="20,10" opacity="0.5"><animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="30s" repeatCount="indefinite"/></circle>
                <path d="M 100 20 L 170 160 L 30 160 Z" stroke-width="3" />
                <circle cx="100" cy="90" r="15" fill="#00ff41" />
                <path d="M 100 90 L 100 160" />
            </g>
        </svg>
    </div>
    <div class="input-group">
        <label class="input-label">SECURE LOGIN REQUIRED</label>
        <input type="password" id="password-input" maxlength="20" placeholder="_ _ _ _ _ _" autocomplete="off">
        <div class="error-msg" id="error-msg">>> ACCESS DENIED: INVALID HASH <<</div>
    </div>
    <div style="margin-top: 40px; font-size: 10px; color: var(--term-dim); text-align: center;">LAST DAY NETWORK // V.5.0.4 (CLOUD)</div>
</div>

<!-- DASHBOARD -->
<div id="dashboard-screen" class="screen">
    <div class="hub-header">
        <div><div style="font-size: 28px; font-weight: bold;">OPERATING SYSTEM: SINGULARITY</div><div style="font-size: 12px; color: var(--term-dim); margin-top: 5px;">UNIT: 734-ALPHA | LOCATION: DEAD CITY</div></div>
        <div style="text-align: right;"><div>STATUS: <span class="blink" style="color:var(--term-green)">ONLINE</span></div><button id="logout-btn" class="nav-btn" style="margin-top: 5px; border-color: var(--term-alert); color: var(--term-alert);">[ LOGOUT ]</button></div>
    </div>
    <div class="dashboard-grid">
        <div class="menu-tile" id="btn-open-relations">
            <div class="tile-icon">⚠</div><div class="tile-title">DIPLOMACY</div><div class="tile-desc">Статусы отношений с фракциями зоны.</div>
        </div>
        <div class="menu-tile" id="btn-open-roster">
            <div class="tile-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="square"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M23 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>
            </div>
            <div class="tile-title">PERSONNEL</div><div class="tile-desc">Личный состав. Мониторинг показателей.</div>
        </div>
        <div class="menu-tile" id="btn-open-ops">
            <div class="tile-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="square"><circle cx="12" cy="12" r="10"></circle><line x1="22" y1="12" x2="18" y2="12"></line><line x1="6" y1="12" x2="2" y2="12"></line><line x1="12" y1="6" x2="12" y2="2"></line><line x1="12" y1="22" x2="12" y2="18"></line></svg>
            </div>
            <div class="tile-title">TACTICAL</div><div class="tile-desc">Планирование боевых задач.</div>
        </div>
        <div class="menu-tile" id="btn-open-research">
            <div class="tile-icon">☢</div><div class="tile-title">RESEARCH</div><div class="tile-desc">База данных разработок.</div>
        </div>
    </div>
</div>

<div id="relations-screen" class="screen">
    <div class="hub-header"><div style="font-size: 24px; font-weight: bold;">FACTION RELATIONS</div><button class="nav-btn btn-back-dash"><< DASHBOARD</button></div>
    <p style="color: var(--term-dim); margin-bottom: 20px;">>> LIVE SYNCHRONIZATION: NOOSPHERE NET</p>
    <table class="data-table"><thead><tr><th style="width: 40%">FACTION NAME</th><th style="width: 40%">CURRENT STATUS</th><th style="width: 20%">THREAT LEVEL</th></tr></thead><tbody id="relations-body"></tbody></table>
</div>

<div id="roster-screen" class="screen">
    <div class="hub-header"><div style="font-size: 24px; font-weight: bold;">UNIT ROSTER</div><button class="nav-btn btn-back-dash"><< DASHBOARD</button></div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><p style="color: var(--term-dim); margin: 0;">>> LIVE BIOMETRIC FEED</p><button id="btn-add-unit" class="nav-btn" style="font-size: 12px;">+ ADD UNIT</button></div>
    <table class="data-table"><thead><tr><th style="width: 20%">ID INDEX</th><th style="width: 30%">RANK / ROLE</th><th style="width: 30%">VITALS STATUS</th><th style="width: 20%">ACTION</th></tr></thead><tbody id="roster-body"></tbody></table>
</div>

<div id="operations-screen" class="screen">
    <div class="hub-header"><div style="font-size: 24px; font-weight: bold;">TACTICAL OPERATIONS</div><button class="nav-btn btn-back-dash"><< DASHBOARD</button></div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><p style="color: var(--term-dim); margin: 0;">>> MISSION CONTROL</p><button id="btn-add-op" class="nav-btn" style="font-size: 12px;">+ ADD OPERATION</button></div>
    <table class="data-table"><thead><tr><th style="width: 10%">CODENAME</th><th style="width: 15%">START</th><th style="width: 5%">UNITS</th><th style="width: 10%">SECTOR</th><th style="width: 25%">OBJECTIVES</th><th style="width: 10%">SECRECY</th><th style="width: 15%">STATUS</th><th style="width: 10%">ACTION</th></tr></thead><tbody id="operations-body"></tbody></table>
</div>

<div id="main-hub" class="screen">
    <div class="hub-header"><div><div style="font-size: 24px; font-weight: bold;">RESEARCH DATABASE</div><div style="font-size: 12px; color: var(--term-dim);">ACCESS LEVEL: BETA</div></div><div style="text-align: right;"><button class="nav-btn btn-back-dash"><< DASHBOARD</button><button id="btn-add-proj" class="nav-btn" style="margin-top: 5px;">+ ADD PROJECT</button></div></div>
    <div class="grid-container" id="research-grid"></div>
</div>

<div id="modal-access-denied" class="modal-overlay"><div class="modal-box alert"><h1 style="border-bottom: 2px solid var(--term-alert); padding-bottom: 10px;">ACCESS DENIED</h1><p style="color: #fff;">ТРЕБУЕТСЯ КЛЮЧ "АРХИТЕКТОРА".</p><div style="margin-top: 30px; font-size: 60px;"><span class="blink">!</span></div><br><button class="modal-btn danger close-modal">ЗАКРЫТЬ</button></div></div>
<div id="modal-corrupted" class="modal-overlay"><div class="modal-box alert"><h1 style="border-bottom: 2px solid var(--term-alert); padding-bottom: 10px;">DATA CORRUPTED</h1><p style="color: #fff;">SOURCE FILE MISSING OR DAMAGED.</p><div style="margin-top: 30px; font-size: 40px; color: var(--term-alert);">404</div><br><button class="modal-btn danger close-modal">ЗАКРЫТЬ</button></div></div>

<div id="modal-add-unit" class="modal-overlay"><div class="modal-box"><h1 style="border-bottom: 2px solid var(--term-green); padding-bottom: 10px;">ADD NEW UNIT</h1><p>ENTER IDENTIFICATION INDEX:</p><input type="text" id="new-unit-id" class="modal-input" placeholder="000-CODENAME" maxlength="15"><div><button id="confirm-add-unit" class="modal-btn">CONFIRM</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div></div>
<div id="modal-delete-unit" class="modal-overlay"><div class="modal-box alert"><h1 style="border-bottom: 2px solid var(--term-alert); padding-bottom: 10px;">TERMINATE RECORD?</h1><p>THIS ACTION CANNOT BE UNDONE.</p><div style="margin-top: 30px;"><button id="confirm-delete-unit" class="modal-btn danger">TERMINATE</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div></div>

<div id="modal-add-project" class="modal-overlay"><div class="modal-box"><h1 style="border-bottom: 2px solid var(--term-green); padding-bottom: 10px;">INIT NEW PROTOCOL</h1><p style="text-align: left; margin-bottom: 5px; font-size: 12px; color: var(--term-dim);">CODENAME (FILE NAME):</p><input type="text" id="new-proj-code" class="modal-input" placeholder="e.g. GBS-5" style="margin: 0 0 15px 0;"><p style="text-align: left; margin-bottom: 5px; font-size: 12px; color: var(--term-dim);">DESCRIPTION:</p><input type="text" id="new-proj-desc" class="modal-input" placeholder="BRIEF SUMMARY" style="margin: 0 0 15px 0;"><p style="text-align: left; margin-bottom: 5px; font-size: 12px; color: var(--term-dim);">ACCESS CLEARANCE:</p><select id="new-proj-status" class="term-select" style="margin-bottom: 20px;"><option value="ALPHA">ALPHA</option><option value="BETA">BETA (CURRENT)</option><option value="OMEGA">OMEGA</option></select><label for="project-file-upload" class="nav-btn" style="display:block; margin-bottom:15px; cursor:pointer; border-style:dashed;">>> UPLOAD SOURCE FILE (.HTML)</label><input type="file" id="project-file-upload" style="display:none" accept=".html"><div id="file-name-display" style="color:var(--term-dim); font-size:12px; margin-bottom:20px;">NO DATA CARTRIDGE INSERTED</div><div><button id="confirm-add-proj" class="modal-btn">INITIALIZE</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div></div>
<div id="modal-delete-project" class="modal-overlay"><div class="modal-box alert"><h1 style="border-bottom: 2px solid var(--term-alert); padding-bottom: 10px;">ERASE PROTOCOL?</h1><p>CONFIRM DELETION OF PROJECT DATA.</p><div style="margin-top: 30px;"><button id="confirm-delete-proj" class="modal-btn danger">ERASE</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div></div>

<div id="modal-add-operation" class="modal-overlay"><div class="modal-box"><h1 style="border-bottom: 2px solid var(--term-green); padding-bottom: 10px;">NEW OPERATION</h1><p style="text-align: left; margin-bottom: 5px; font-size: 12px; color: var(--term-dim);">CODENAME:</p><input type="text" id="new-op-code" class="modal-input" placeholder="OP-TITAN" style="margin: 0 0 10px 0;"><p style="text-align: left; margin-bottom: 5px; font-size: 12px; color: var(--term-dim);">START DATE & TIME:</p><input type="text" id="new-op-time" class="modal-input" placeholder="DD.MM.YYYY HH:MM" style="margin: 0 0 10px 0;"><p style="text-align: left; margin-bottom: 5px; font-size: 12px; color: var(--term-dim);">UNIT COUNT:</p><input type="text" id="new-op-units" class="modal-input" placeholder="4" style="margin: 0 0 10px 0;"><p style="text-align: left; margin-bottom: 5px; font-size: 12px; color: var(--term-dim);">SECTOR / LOCATION:</p><input type="text" id="new-op-loc" class="modal-input" placeholder="AGROPROM" style="margin: 0 0 10px 0;"><p style="text-align: left; margin-bottom: 5px; font-size: 12px; color: var(--term-dim);">MISSION OBJECTIVES:</p><input type="text" id="new-op-obj" class="modal-input" placeholder="ELIMINATE TARGET / RETRIEVE DATA" style="margin: 0 0 10px 0;"><p style="text-align: left; margin-bottom: 5px; font-size: 12px; color: var(--term-dim);">SECRECY STATUS:</p><select id="new-op-secrecy" class="term-select" style="margin-bottom: 20px;"><option value="SECRET">SECRET (RED)</option><option value="NON-SECRET">NON-SECRET (GREEN)</option></select><div><button id="confirm-add-op" class="modal-btn">CONFIRM</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div></div>
<div id="modal-delete-operation" class="modal-overlay"><div class="modal-box alert"><h1 style="border-bottom: 2px solid var(--term-alert); padding-bottom: 10px;">ABORT OPERATION?</h1><p>CONFIRM CANCELLATION OF TACTICAL MISSION.</p><div style="margin-top: 30px;"><button id="confirm-delete-op" class="modal-btn danger">ABORT</button><button class="modal-btn cancel close-modal">CANCEL</button></div></div></div>

<!-- IFRAME DOC VIEWER -->
<div id="doc-viewer" class="screen">
    <div class="doc-controls">
        <button id="btn-close-doc" class="back-btn" onclick="window.closeDocument()">[ < ] CLOSE FILE</button>
    </div>
    <iframe id="doc-frame" src="about:blank"></iframe>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDItyHZsBjradE8WE-qtIutVKXux-mWoiI",
        authDomain: "last-day-terminal.firebaseapp.com",
        projectId: "last-day-terminal",
        storageBucket: "last-day-terminal.firebasestorage.app",
        messagingSenderId: "283501483006",
        appId: "1:283501483006:web:68888bf5ea676579d9e6af"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- GLOBAL SCOPE ---
    const SECRET_KEY = "LD-X7-OMEGA";
    let delDocId = null;
    let delCollection = null;
    
    // File content buffer
    let uploadedFileContent = null;

    // --- DEFAULTS ---
    const defaultFactions = [
        { name: "ОДИНОЧКИ (LONERS)", status: "NEUTRAL" }, { name: "ДОЛГ (DUTY)", status: "WAR" }, { name: "СВОБОДА (FREEDOM)", status: "WAR" }, 
        { name: "БАНДИТЫ (BANDITS)", status: "ALLIANCE" }, { name: "НАЕМНИКИ (MERCS)", status: "NEUTRAL" }, { name: "ВОЕННЫЕ (MILITARY)", status: "WAR" }, 
        { name: "УЧЕНЫЕ (ECOLOGISTS)", status: "NEUTRAL" }, { name: "МОНОЛИТ (MONOLITH)", status: "ALLIANCE" }, { name: "ЧИСТОЕ НЕБО (CLEAR SKY)", status: "WAR" }, 
        { name: "РЕНЕГАТЫ (RENEGADES)", status: "NEUTRAL" }, { name: "ЧЕРНЫЙ РЫНОК (BLACK MARKET)", status: "NEUTRAL" }, 
        { name: "ВОЕННЫЕ СТАЛКЕРЫ (MILITARY STALKERS)", status: "WAR" }, { name: "ИИГ (ISG)", status: "WAR" }, 
        { name: "ГРЕХ (SIN)", status: "ALLIANCE" }, { name: "ТЕМНЫЕ СТАЛКЕРЫ (DARK STALKERS)", status: "NEUTRAL" }, 
        { name: "СБУ (SBU)", status: "WAR" }, { name: "ОХРАНА ДЕРЕВНИ (VILLAGE GUARD)", status: "WAR" }, 
        { name: "ОХРАНА ЯНОВА (YANOV GUARD)", status: "WAR" }, { name: "РЕЙДЕРЫ (RAIDERS)", status: "WAR" }, 
        { name: "ТЕНИ (SHADOWS)", status: "NEUTRAL" }, { name: "КАМФОГОР (KAMFOGOR)", status: "NEUTRAL" }, 
        { name: "МОНОЛИТ-СЕВЕР (MONOLITH NORTH)", status: "ALLIANCE" }, { name: "СВОБОДА-СЕВЕР (FREEDOM NORTH)", status: "WAR" }, 
        { name: "БАНДИТЫ-СЕВЕР (BANDITS NORTH)", status: "ALLIANCE" }
    ];

    // Empty array - no hardcoded projects
    const hardcodedProjects = [];

    // --- DB HELPERS ---
    async function updateDocField(collectionName, docId, field, value) {
        const ref = doc(db, collectionName, docId);
        await updateDoc(ref, { [field]: value });
    }

    async function deleteDocument(collectionName, docId) {
        await deleteDoc(doc(db, collectionName, docId));
    }

    async function addDocument(collectionName, data) {
        await addDoc(collection(db, collectionName), { ...data, timestamp: Date.now() });
    }

    // --- RENDERERS ---
    function renderFactions(data) {
        const tbody = document.getElementById('relations-body');
        if (!tbody) return;
        tbody.innerHTML = '';
        data.sort((a, b) => a.name.localeCompare(b.name));
        
        data.forEach(item => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-status', item.status);
            let threat = item.status === "WAR" ? "CRITICAL" : item.status === "ALLIANCE" ? "MINIMAL" : "MODERATE";
            
            tr.innerHTML = `
                <td style="font-weight:bold;">${item.name}</td>
                <td>
                    <select class="term-select" style="background:#000;">
                        <option value="NEUTRAL" ${item.status === 'NEUTRAL'?'selected':''}>НЕЙТРАЛИТЕТ</option>
                        <option value="ALLIANCE" ${item.status === 'ALLIANCE'?'selected':''}>СОЮЗ</option>
                        <option value="WAR" ${item.status === 'WAR'?'selected':''}>ВОЙНА</option>
                    </select>
                </td>
                <td style="color:${item.status==='WAR'?'#ff3333':'#00ff41'}">${threat}</td>
            `;
            if (item.id) tr.querySelector('select').addEventListener('change', (e) => updateDocField('factions', item.id, 'status', e.target.value));
            tbody.appendChild(tr);
        });
    }

    function renderRoster(data) {
        const tbody = document.getElementById('roster-body');
        if (!tbody) return;
        tbody.innerHTML = '';
        
        if (data && data.length > 0) {
             data.sort((a, b) => a.timestamp - b.timestamp);
             data.forEach(u => {
                const tr = document.createElement('tr');
                let hc = u.health==="WOUNDED"?"#ffcc00":u.health==="CRITICAL"||u.health==="DECEASED"?"#ff3333":u.health==="M.I.A."?"#888":"#00ff41";
                
                tr.innerHTML = `
                    <td style="font-weight:bold; color:#fff;">${u.unitId}</td>
                    <td><select class="term-select rank-select" style="border:none; background:transparent; padding:0;">
                        <option ${u.rank==='ARCHITECT'?'selected':''}>ARCHITECT</option>
                        <option ${u.rank==='COGNITOR'?'selected':''}>COGNITOR</option>
                        <option ${u.rank==='OPERATOR'?'selected':''}>OPERATOR</option>
                        <option ${u.rank==='REDEEMED'?'selected':''}>REDEEMED</option>
                        <option ${u.rank==='NEOPHYTE'?'selected':''}>NEOPHYTE</option>
                    </select></td>
                    <td><select class="term-select health-select" style="color:${hc}; border-color:${hc}; background:transparent;">
                        <option value="ACTIVE" ${u.health==='ACTIVE'?'selected':''}>ACTIVE</option>
                        <option value="WOUNDED" ${u.health==='WOUNDED'?'selected':''}>WOUNDED</option>
                        <option value="CRITICAL" ${u.health==='CRITICAL'?'selected':''}>CRITICAL</option>
                        <option value="M.I.A." ${u.health==='M.I.A.'?'selected':''}>M.I.A.</option>
                        <option value="DECEASED" ${u.health==='DECEASED'?'selected':''}>DECEASED</option>
                    </select></td>
                    <td><button class="btn-delete">[ X ]</button></td>
                `;

                tr.querySelector('.rank-select').addEventListener('change', (e) => updateDocField('roster', u.id, 'rank', e.target.value));
                tr.querySelector('.health-select').addEventListener('change', (e) => updateDocField('roster', u.id, 'health', e.target.value));
                tr.querySelector('.btn-delete').addEventListener('click', () => {
                    delDocId = u.id; delCollection = 'roster';
                    document.getElementById('modal-delete-unit').style.display = 'flex';
                });

                tbody.appendChild(tr);
            });
        }
    }

    function renderProjects(userProjects) {
        const container = document.getElementById('research-grid');
        if (!container) return;
        container.innerHTML = '';
        
        // 1. Render Hardcoded (now empty loop)
        hardcodedProjects.forEach(p => {
            const div = document.createElement('div');
            div.className = "project-card";
            container.appendChild(div);
        });

        // 2. Render User Projects (From DB)
        if (userProjects && userProjects.length > 0) {
            userProjects.sort((a, b) => a.timestamp - b.timestamp);
            userProjects.forEach(p => {
                const div = document.createElement('div');
                div.className = "project-card";
                
                let statusText = p.status === "BETA" ? "AVAILABLE" : "RESTRICTED";
                let statusClass = p.status === "BETA" ? "status-open" : "status-locked";
                let footer = p.status === "BETA" ? ">> CLICK TO ACCESS" : `>> LEVEL_${p.status}_REQ`;
                let footerColor = p.status === "BETA" ? "var(--term-dim)" : "var(--term-alert)";

                div.innerHTML = `<div class="card-status ${statusClass}">${statusText}</div><div class="card-title">${p.title}</div><div class="card-desc">${p.desc}</div><div style="margin-top: 20px; color: ${footerColor}; font-size: 12px; border-top: 1px dashed var(--term-dim); padding-top: 5px;">${footer}</div>`;
                
                div.addEventListener('click', () => { 
                    if(p.status === "BETA") {
                        if (p.content) window.openUserProject(p.content);
                        else window.openCorrupted();
                    } else {
                        window.accessDenied();
                    }
                });

                const delBtn = document.createElement('button');
                delBtn.className = "btn-delete card-delete-pos";
                delBtn.innerText = "[ X ]";
                delBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    delDocId = p.id; delCollection = 'projects';
                    document.getElementById('modal-delete-project').style.display = 'flex';
                });

                div.appendChild(delBtn);
                container.appendChild(div);
            });
        }
    }

    function renderOperations(data) {
        const tbody = document.getElementById('operations-body');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (data && data.length > 0) {
            data.sort((a, b) => a.timestamp - b.timestamp);
            data.forEach(op => {
                const tr = document.createElement('tr');
                let sc = op.secrecy === "SECRET" ? "color:var(--term-alert);" : "color:var(--term-green);";
                let stc = op.status==="COMPLETED"?"var(--term-green)":op.status==="FAILED"?"var(--term-alert)":op.status==="IN_PROGRESS"?"var(--term-warn)":op.status==="DECLASSIFIED"?"var(--term-orange)":"#888";
                tr.innerHTML = `<td style="font-weight:bold; color:#fff;">${op.code}</td><td>${op.time}</td><td>${op.units}</td><td>${op.sector}</td><td style="font-size:12px; color:#aaa;">${op.objectives||'N/A'}</td><td style="${sc} font-weight:bold;">${op.secrecy}</td><td><select class="term-select status-select" style="color:${stc}; border-color:${stc}; background:#000;"><option value="PENDING" ${op.status==='PENDING'?'selected':''}>PENDING</option><option value="IN_PROGRESS" ${op.status==='IN_PROGRESS'?'selected':''}>IN PROGRESS</option><option value="COMPLETED" ${op.status==='COMPLETED'?'selected':''}>COMPLETED</option><option value="FAILED" ${op.status==='FAILED'?'selected':''}>FAILED</option><option value="DECLASSIFIED" ${op.status==='DECLASSIFIED'?'selected':''}>DECLASSIFIED</option></select></td><td><button class="btn-delete">[ X ]</button></td>`;
                tr.querySelector('.status-select').addEventListener('change', (e) => updateDocField('operations', op.id, 'status', e.target.value));
                tr.querySelector('.btn-delete').addEventListener('click', () => {
                    delDocId = op.id; delCollection = 'operations';
                    document.getElementById('modal-delete-operation').style.display = 'flex';
                });
                tbody.appendChild(tr);
            });
        }
    }

    // --- APP INIT ---
    async function initApp() {
        renderFactions(defaultFactions); renderProjects([]); renderRoster([]); renderOperations([]);
        try {
            await signInAnonymously(auth);

            onSnapshot(collection(db, "factions"), (snapshot) => {
                if(snapshot.empty) {
                    defaultFactions.forEach(f => addDocument('factions', f));
                } else {
                    renderFactions(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
                }
            });

            onSnapshot(collection(db, "roster"), (snapshot) => {
                renderRoster(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
            });

            onSnapshot(collection(db, "projects"), (snapshot) => {
                renderProjects(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
            });

            onSnapshot(collection(db, "operations"), (snapshot) => {
                renderOperations(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
            });
        } catch (error) {
            console.error("Firebase init error:", error);
        }
    }

    initApp();

    // --- FILE UPLOAD LISTENER ---
    document.getElementById('project-file-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const display = document.getElementById('file-name-display');
        
        if (!file) {
            display.textContent = "NO DATA CARTRIDGE INSERTED";
            display.style.color = "var(--term-dim)";
            uploadedFileContent = null;
            return;
        }

        if (file.type !== 'text/html' && !file.name.toLowerCase().endsWith('.html')) {
            display.textContent = "ENCRYPTION MISMATCH: ONLY .HTML DATA ACCEPTED";
            display.style.color = "var(--term-alert)";
            uploadedFileContent = null;
            e.target.value = ''; 
            return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
            uploadedFileContent = event.target.result;
            display.textContent = "DATA LOADED: " + file.name.toUpperCase();
            display.style.color = "var(--term-green)";
        };
        reader.readAsText(file);
    });

    // --- GLOBAL WINDOW EXPORTS ---
    
    // Navigation
    window.openScreen = (screenId) => {
        document.querySelectorAll('.screen').forEach(el => { el.style.display = 'none'; el.classList.remove('screen-transition'); });
        const target = document.getElementById(screenId);
        target.style.display = (screenId === 'doc-viewer') ? 'flex' : 'flex'; // Fix: Doc viewer needs flex for iframe layout
        target.classList.add('screen-transition');
    };

    window.closeDocument = () => {
        const frame = document.getElementById('doc-frame');
        frame.src = "about:blank";
        window.openScreen('main-hub'); 
    };
    
    window.accessDenied = () => document.getElementById('modal-access-denied').style.display = 'flex';
    window.openCorrupted = () => document.getElementById('modal-corrupted').style.display = 'flex';
    
    window.openDocument = (docId) => { 
        // Hardcode removed, kept for safety
    };

    window.openUserProject = (content) => {
        const frame = document.getElementById('doc-frame');
        const doc = frame.contentWindow.document;
        doc.open();
        doc.write(content);
        doc.close();
        window.openScreen('doc-viewer');
    }

    window.logout = () => { document.getElementById('password-input').value = ""; document.getElementById('password-input').style.borderColor = "#00661a"; window.openScreen('login-screen'); };

    // Modals
    window.closeModal = (id) => {
        document.getElementById(id).style.display = 'none';
        if (id === 'modal-add-project') {
            document.getElementById('project-file-upload').value = '';
            document.getElementById('file-name-display').textContent = "NO DATA CARTRIDGE INSERTED";
            document.getElementById('file-name-display').style.color = "var(--term-dim)";
            uploadedFileContent = null;
        }
    };
    
    window.openAddModal = () => { document.getElementById('modal-add-unit').style.display = 'flex'; document.getElementById('new-unit-id').value = ''; document.getElementById('new-unit-id').focus(); };
    window.openAddProjectModal = () => { document.getElementById('modal-add-project').style.display = 'flex'; document.getElementById('new-proj-code').value=''; document.getElementById('new-proj-desc').value=''; };
    window.openAddOperationModal = () => { document.getElementById('modal-add-operation').style.display = 'flex'; document.getElementById('new-op-code').value=''; document.getElementById('new-op-time').value=''; };

    // Confirm Actions
    document.getElementById('confirm-add-unit').addEventListener('click', () => {
        const v = document.getElementById('new-unit-id').value.trim().toUpperCase();
        if(v) { addDocument('roster', { unitId: v, rank: "NEOPHYTE", health: "ACTIVE" }); window.closeModal('modal-add-unit'); }
    });

    document.getElementById('confirm-add-proj').addEventListener('click', () => {
        const c = document.getElementById('new-proj-code').value.trim().toUpperCase();
        const d = document.getElementById('new-proj-desc').value.trim();
        const s = document.getElementById('new-proj-status').value;
        if(c && d) { addDocument('projects', { code: c, title: "PROJECT: " + c, desc: d, status: s, content: uploadedFileContent }); window.closeModal('modal-add-project'); }
    });

    document.getElementById('confirm-add-op').addEventListener('click', () => {
        const c = document.getElementById('new-op-code').value.trim().toUpperCase();
        const t = document.getElementById('new-op-time').value.trim();
        const u = document.getElementById('new-op-units').value.trim();
        const s = document.getElementById('new-op-loc').value.trim().toUpperCase();
        const o = document.getElementById('new-op-obj').value.trim().toUpperCase();
        const sec = document.getElementById('new-op-secrecy').value;
        if(c && t) { addDocument('operations', { code:c, time:t, units:u, sector:s, objectives:o, secrecy:sec, status: "PENDING" }); window.closeModal('modal-add-operation'); }
    });

    const performDelete = async (modalId) => {
        if(delDocId && delCollection) {
            await deleteDocument(delCollection, delDocId);
            delDocId = null; delCollection = null;
            window.closeModal(modalId);
        }
    };

    document.getElementById('confirm-delete-unit').addEventListener('click', () => performDelete('modal-delete-unit'));
    document.getElementById('confirm-delete-proj').addEventListener('click', () => performDelete('modal-delete-project'));
    document.getElementById('confirm-delete-op').addEventListener('click', () => performDelete('modal-delete-operation'));

    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', (e) => { e.target.closest('.modal-overlay').style.display = 'none'; });
    });

    const bootLines = ["LAST DAY OS v.5.0.3", "INITIALIZING NETWORK...", "CONNECTING TO FIREBASE... ESTABLISHED", "SYNCING NOOSPHERE... OK", "SYSTEM READY."];
    let lineIndex = 0;
    const bootScreen = document.getElementById('boot-screen');
    const loginScreen = document.getElementById('login-screen');
    const passInput = document.getElementById('password-input');

    function typeBoot() {
        if (lineIndex < bootLines.length) {
            const p = document.createElement('div');
            p.style.fontFamily = "Share Tech Mono";
            p.innerHTML = `> ${bootLines[lineIndex]}`;
            bootScreen.appendChild(p);
            lineIndex++;
            setTimeout(typeBoot, 150);
        } else {
            setTimeout(() => { bootScreen.style.display = 'none'; loginScreen.style.display = 'flex'; passInput.focus(); }, 1000);
        }
    }
    window.onload = typeBoot;

    passInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            if (passInput.value.toUpperCase().trim() === SECRET_KEY) {
                passInput.style.borderColor = "#00ff41";
                setTimeout(() => window.openScreen('dashboard-screen'), 500);
            } else {
                document.getElementById('error-msg').style.opacity = 1;
                passInput.value = "";
                setTimeout(() => document.getElementById('error-msg').style.opacity = 0, 2000);
            }
        }
    });

    document.getElementById('btn-open-relations').addEventListener('click', () => window.openScreen('relations-screen'));
    document.getElementById('btn-open-roster').addEventListener('click', () => window.openScreen('roster-screen'));
    document.getElementById('btn-open-ops').addEventListener('click', () => window.openScreen('operations-screen'));
    document.getElementById('btn-open-research').addEventListener('click', () => window.openScreen('main-hub'));
    
    document.querySelectorAll('.btn-back-dash').forEach(btn => btn.addEventListener('click', () => window.openScreen('dashboard-screen')));
    document.getElementById('btn-add-unit').addEventListener('click', window.openAddModal);
    document.getElementById('btn-add-proj').addEventListener('click', window.openAddProjectModal);
    document.getElementById('btn-add-op').addEventListener('click', window.openAddOperationModal);
    document.getElementById('logout-btn').addEventListener('click', window.logout);
</script>
</body>
</html>
